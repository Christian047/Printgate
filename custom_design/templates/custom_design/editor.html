{% extends 'base1.html' %}
{% load static %}
{% load design_filters %}
{% block title %}Design Editor - {{ product_type.name }}{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<style>
    :root {
        --sidebar-width: 260px;
        --header-height: 60px;
        --footer-height: 50px;
        --mobile-controls-height: 100px;
        --mobile-breakpoint: 768px;
        --mobile-sidebar-width: 60px;
        --mobile-sidebar-expanded-width: 200px;
    }

    .design-editor {
        display: flex;
        flex-direction: column;
        height: calc(100vh - var(--header-height));
        overflow: hidden;
    }

    .editor-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }

    .design-sidebar {
        width: var(--sidebar-width);
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 10;
        transition: transform 0.3s ease;
    }

    .sidebar-nav {
        background-color: #f0f0f0;
        border-bottom: 1px solid #dee2e6;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .design-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .design-tabs li {
        flex: 1;
        text-align: center;
    }

    .design-tabs a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 8px;
        color: #495057;
        text-decoration: none;
        border-bottom: 2px solid transparent;
        font-size: 14px;
        transition: all 0.2s;
    }

    .design-tabs a i {
        font-size: 18px;
        margin-bottom: 5px;
        margin-right: 0; /* Override previous margin */
    }

    .design-tabs a.active {
        background-color: #fff;
        border-bottom-color: #0d6efd;
        color: #0d6efd;
    }

    .design-tabs a:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        overflow: auto;
        position: relative;
    }

    #design-canvas {
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .canvas-wrapper {
        position: relative;
    }

    /* Replace your existing .canvas-container styles with this */
    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        position: relative;
        
        /* These are the important properties for scrolling */
        overflow: auto; /* Force horizontal scrollbar */
    }

    /* And make sure this comes after the canvas-container definition */
    .canvas-wrapper {
        position: relative;
        padding: 0 20px;
    }

    .editor-header {
        display: flex;
        align-items: center;
        height: var(--header-height);
        padding: 0 15px;
        background-color: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    .editor-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: var(--footer-height);
        padding: 0 15px;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
    }

    .control-section {
        margin-bottom: 24px;
    }

    .control-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
    }

    .control-section h3 i {
        margin-right: 8px;
    }

    .control-row {
        display: flex;
        margin-bottom: 8px;
        gap: 8px;
    }

    .control-item {
        flex: 1;
    }

    .btn-group {
        display: flex;
        gap: 4px;
    }

    .color-swatch {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    .variant-options {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
    }

    .variant-option {
        border: 2px solid #dee2e6;
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        overflow: hidden;
    }

    .variant-option.active {
        border-color: #0d6efd;
    }

    .variant-option img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Moving history and edit controls to fixed floating bar */
    .canvas-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 100;
    }

    .canvas-controls-group {
        display: flex;
        gap: 5px;
        border-right: 1px solid #dee2e6;
        padding-right: 10px;
        margin-right: 5px;
    }

    /* Add these styles for the pan controls */
    .pan-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 2px;
    }

    .pan-btn {
        width: 36px;
        height: 36px;
    }

    /* Make the center button visually distinct */
    #pan-center-btn {
        background-color: #f8f9fa;
    }
    
    .canvas-controls-group:last-child {
        border-right: none;
        padding-right: 0;
        margin-right: 0;
    }

    /* Target specific button for consistency */
    .btn-icon {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    /* Hide content until it's active */
    .tab-content:not(.active) {
        display: none;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .loading-overlay.active {
        visibility: visible;
        opacity: 1;
    }

    /* Save Design Dialog */
    .save-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        width: 400px;
        max-width: 90vw;
        display: none;
    }

    .save-dialog.active {
        display: block;
    }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .dialog-overlay.active {
        display: block;
    }




/* Editor overlay for templates that require purchase */
.purchase-editor-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.9);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    backdrop-filter: blur(5px);
}

.purchase-editor-content {
    max-width: 500px;
    padding: 2rem;
    background-color: #fff;
    border: 2px solid #ffd700;
    border-radius: 10px;
    box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
    text-align: center;
}

.purchase-icon {
    font-size: 3rem;
    margin-bottom: 1rem;
    color: #ffd700;
}

.purchase-title {
    color: #000;
    font-weight: bold;
    margin-bottom: 1rem;
}

.purchase-description {
    color: #555;
    margin-bottom: 1.5rem;
}

.template-preview-image {
    max-width: 100%;
    border-radius: 8px;
    border: 1px solid #ddd;
    margin-bottom: 1.5rem;
}

.purchase-price {
    font-size: 2.5rem;
    font-weight: bold;
    color: #000;
    margin-bottom: 1rem;
}

.purchase-price .currency {
    color: #b8860b;
    font-size: 1.5rem;
}

.btn-purchase-now {
    background: #000;
    border: 2px solid #ffd700;
    padding: 10px 20px;
    font-weight: bold;
    color: #ffd700;
    transition: all 0.3s;
}

.btn-purchase-now:hover {
    background: #ffd700;
    color: #000;
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
}

/* Payment methods */
.payment-methods {
    display: flex;
    justify-content: center;
    margin-bottom: 1.5rem;
    gap: 10px;
}

.payment-method {
    border: 1px solid #dee2e6;
    border-radius: 4px;
    padding: 10px 15px;
    cursor: pointer;
    transition: all 0.2s;
}

.payment-method:hover, .payment-method.active {
    border-color: #ffd700;
    background-color: rgba(255, 215, 0, 0.1);
}

.payment-method img {
    height: 30px;
    width: auto;
}



    /* Mobile optimization */
    @media (max-width: 768px) {
        /* Compact sidebar in collapsed state */
        .design-sidebar {
            width: var(--mobile-sidebar-width);
            transform: translateX(0);
            transition: width 0.3s ease, transform 0.3s ease;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            overflow: visible; /* Allow expanded content to overflow */
            position: absolute;
            height: 100%;
            z-index: 100;
        }
        
        /* Make sidebar collapsible completely when needed */
        .design-sidebar.collapsed {
            transform: translateX(calc(-1 * var(--mobile-sidebar-width)));
        }
        
        /* Handle expanded state */
        .design-sidebar.expanded {
            width: var(--mobile-sidebar-expanded-width);
        }
        
        /* Simplify tabs to icon-only in collapsed state */
        .design-sidebar:not(.expanded) .design-tabs a span {
            display: none;
        }
        
        .design-sidebar:not(.expanded) .design-tabs a i {
            font-size: 24px;
            margin-bottom: 0;
        }
        
        /* Hide sidebar content when collapsed */
        .design-sidebar:not(.expanded) .sidebar-content {
            opacity: 0;
            pointer-events: none;
        }
        
        /* Show sidebar content when expanded */
        .design-sidebar.expanded .sidebar-content {
            opacity: 1;
            pointer-events: auto;
            transition: opacity 0.2s ease 0.1s; /* Delay to avoid flash during transition */
        }
        
        /* Adjust canvas to use available space */
        .canvas-container {
            margin-left: var(--mobile-sidebar-width);
            width: calc(100% - var(--mobile-sidebar-width));
            transition: margin-left 0.3s ease, width 0.3s ease;
        }
        
        /* When sidebar is collapsed, give full width to canvas */
        .design-sidebar.collapsed ~ .canvas-container {
            margin-left: 0;
            width: 100%;
        }
        
        /* When sidebar is expanded, push canvas further */
        .design-sidebar.expanded ~ .canvas-container {
            margin-left: var(--mobile-sidebar-expanded-width);
            width: calc(100% - var(--mobile-sidebar-expanded-width));
        }
        
        /* Improved toggle button for sidebar */
        .btn-toggle-sidebar {
            display: flex !important;
            align-items: center;
            justify-content: center;
            position: fixed;
            left: calc(var(--mobile-sidebar-width) - 15px);
            top: 50%;
            transform: translateY(-50%);
            z-index: 101;
            width: 30px;
            height: 50px;
            border-radius: 0 25px 25px 0;
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-left: none;
            box-shadow: 2px 0 5px rgba(0,0,0,0.1);
            padding: 0;
            transition: left 0.3s ease;
        }
        
        /* Position toggle button properly based on sidebar state */
        .design-sidebar.collapsed ~ .btn-toggle-sidebar {
            left: 0;
        }
        
        .design-sidebar.expanded ~ .btn-toggle-sidebar {
            left: calc(var(--mobile-sidebar-expanded-width) - 15px);
        }
        
        /* Reorganize canvas controls for mobile */
        .canvas-controls {
            position: fixed;
            bottom: 10px;
            right: 10px;
            left: auto;
            transform: none;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background-color: rgba(255, 255, 255, 0.9);
            padding: 8px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            max-width: 50px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .canvas-controls-group {
            display: flex;
            flex-direction: column;
            gap: 4px;
            border-right: none;
            border-bottom: 1px solid #dee2e6;
            padding-right: 0;
            padding-bottom: 8px;
            margin-right: 0;
            margin-bottom: 4px;
        }
        
        /* Add a toggle for canvas controls on mobile */
        .canvas-controls-toggle {
            display: block;
            position: fixed;
            right: 10px;
            bottom: 10px;
            width: 50px;
            height: 50px;
            background-color: white;
            border-radius: 50%;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            z-index: 102;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Collapse pan controls for better space use */
        .pan-controls {
            display: none;
        }
        
        .pan-controls.active {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(3, 1fr);
            gap: 2px;
        }
        
        .pan-btn {
            width: 30px;
            height: 30px;
            padding: 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Touch-friendly buttons */
        .btn-icon {
            min-width: 40px;
            min-height: 40px;
        }
        
        /* Fullscreen mode styles */
        .fullscreen-mode .design-sidebar {
            transform: translateX(calc(-1 * var(--mobile-sidebar-width)));
        }
        
        .fullscreen-mode .canvas-container {
            margin-left: 0;
            width: 100%;
        }
        
        /* Add this button to the original controls */
        .btn-fullscreen {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Enhanced tooltip for mobile */
        .mobile-tooltip {
            position: fixed;
            bottom: 70px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            font-size: 14px;
            z-index: 1000;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .mobile-tooltip.visible {
            opacity: 1;
        }
    }
    
    /* Main canvas container */
    .canvas-container {
        overflow: auto; /* Add scrollbars when needed */
    }
    
    /* Button styles for better appearance */
    .btn-primary {
        background-color: #0d6efd;
        border-color: #0d6efd;
    }
    
    .btn-success {
        background-color: #198754;
        border-color: #198754;
    }
    
    .btn-danger {
        background-color: #dc3545;
        border-color: #dc3545;
    }
    
    /* Highlight undo/redo buttons when inactive */
    .btn-icon.disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>
{% endblock %}







{% block content %}






<!-- Hidden fields for pay-per-design checks -->
<input type="hidden" id="template-requires-purchase" value="{% if template.is_premium and not user|has_purchased:template.id %}true{% else %}false{% endif %}">
<input type="hidden" id="template-id" value="{% if template %}{{ template.id }}{% endif %}">
<input type="hidden" id="template-name" value="{% if template %}{{ template.name }}{% endif %}">
<input type="hidden" id="template-image" value="{% if template %}{{ template.preview_image.url }}{% endif %}"> 











<div class="design-editor">
    <!-- Editor Header -->
    <div class="editor-header">
        <div class="d-flex align-items-center flex-grow-1">
            {% comment %} <a href="{% url 'designs:home' %}" class="btn btn-outline-secondary me-3"> {% endcomment %}
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="h5 mb-0">{{ product_type.name }} Designer</h1>

            {% if template %}
            <span class="badge bg-secondary ms-2">Template: {{ template.name }}</span>
            {% endif %}
        </div>

        <div>
            <button id="save-design-btn" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Save Design
            </button>
        </div>
    </div>

    <!-- Main Editor Area -->
    <div class="editor-container">
        <!-- Toggle sidebar button for mobile -->
        <button class="btn btn-toggle-sidebar" id="toggle-sidebar">
            <i class="fas fa-bars"></i>
        </button>
        
        <!-- Sidebar -->
        <div class="design-sidebar" id="design-sidebar">
            <div class="sidebar-nav">
                <ul class="design-tabs">
                    <li>
                        <a href="#" class="active" data-target="tab-text">
                            <i class="fas fa-font"></i>
                            <span>Text</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-upload">
                            <i class="fas fa-upload"></i>
                            <span>Upload</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-product">
                            <i class="fas fa-tshirt"></i>
                            <span>Product</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-content">
                <!-- Text Tab -->
                <div class="tab-content active" id="tab-text">
                    <div class="control-section">
                        <h3><i class="fas fa-plus-circle"></i> Add Text</h3>
                        <div class="form-group mb-3">
                            <textarea id="text-input" class="form-control" rows="2"
                                placeholder="Enter your text here..."></textarea>
                        </div>
                        <button id="add-text-btn" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-1"></i> Add Text
                        </button>
                    </div>

                    <div class="control-section">
                        <h3><i class="fas fa-sliders-h"></i> Text Properties</h3>
                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-family" class="form-label">
                                    <i class="fas fa-font"></i> Font
                                </label>
                                <select id="font-family" class="form-select">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    {% for font in fonts %}
                                    <option value="{{ font.name }}">{{ font.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-size" class="form-label">
                                    <i class="fas fa-text-height"></i> Size
                                </label>
                                <input type="range" class="form-range" id="font-size" min="8" max="120" value="30">
                            </div>
                            <div class="control-item text-center">
                                <label class="form-label"><i class="fas fa-text-height"></i></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="font-size-value" min="8" max="120"
                                        value="30">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-palette"></i> Color
                                </label>
                                <input type="color" class="form-control form-control-color w-100" id="text-color"
                                    value="#000000">
                            </div>
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-tint"></i> Presets
                                </label>
                                <div class="d-flex flex-wrap gap-1">
                                    <div class="color-swatch" style="background-color: #000000" data-color="#000000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ffffff" data-color="#ffffff">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ff0000" data-color="#ff0000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #0000ff" data-color="#0000ff">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-font"></i> Style
                                </label>
                                <div class="btn-group w-100">
                                    <button id="bold-btn" class="btn btn-outline-secondary btn-icon" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button id="italic-btn" class="btn btn-outline-secondary btn-icon" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button id="underline-btn" class="btn btn-outline-secondary btn-icon" title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-align-left"></i> Align
                                </label>
                                <div class="btn-group w-100">
                                    <button id="align-left-btn" class="btn btn-outline-secondary btn-icon" title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button id="align-center-btn" class="btn btn-outline-secondary btn-icon" title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button id="align-right-btn" class="btn btn-outline-secondary btn-icon" title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div class="tab-content" id="tab-upload">
                    <div class="control-section">
                        <h3><i class="fas fa-cloud-upload-alt"></i> Upload Image</h3>
                        <p class="text-muted small">Supported: PNG, JPG, SVG (max 5MB)</p>

                        <div class="mb-3">
                            <input type="file" id="image-upload" class="form-control" accept="image/*">
                        </div>

                        <div id="upload-preview" class="text-center mt-3 d-none">
                            <img id="upload-preview-img" src="" alt="Preview" class="img-fluid border rounded">
                            <button id="add-upload-btn" class="btn btn-primary mt-2 w-100">
                                <i class="fas fa-plus me-1"></i> Add to Design
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Tab -->
                <div class="tab-content" id="tab-product">
                    <div class="control-section">
                        <h3><i class="fas fa-tshirt"></i> Product Options</h3>

                        {% if all_variants %}
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-palette"></i> Color/Variant
                            </label>
                            <div class="variant-options">
                                {% for v in all_variants %}
                                <div class="variant-option {% if variant.id == v.id %}active{% endif %}"
                                    data-variant-id="{{ v.id }}">
                                    {% if v.color_hex %}
                                    <div style="background-color: {{ v.color_hex }}; width: 100%; height: 100%;"></div>
                                    {% else %}
                                    <img src="{{ v.base_image.url }}" alt="{{ v.name }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product_type.has_print_area %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="show-print-area" checked>
                            <label class="form-check-label" for="show-print-area">
                                <i class="fas fa-border-style"></i> Show Print Area
                            </label>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-fill-drip"></i> Canvas Background
                            </label>
                            <select id="canvas-background" class="form-select">
                                <option value="transparent">Transparent</option>
                                <option value="white" selected>White</option>
                                <option value="product">Product Color</option>
                                <option value="custom">Custom Color</option>
                            </select>
                        </div>

                        <div id="custom-bg-color-container" class="mb-3 d-none">
                            <label class="form-label">
                                <i class="fas fa-palette"></i> Custom Background
                            </label>
                            <input type="color" id="custom-bg-color" class="form-control form-control-color w-100"
                                value="#ffffff">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <div id="product-background">
                    {% if variant %}
                    <img src="{{ variant.base_image.url }}" alt="{{ variant.name }}" id="product-image"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">
                    {% endif %}
                </div>
                <canvas id="design-canvas"></canvas>
            </div>
        </div>
        
        <!-- Floating Canvas Controls -->
        <div class="canvas-controls">
            <!-- Undo/Redo Controls -->
            <div class="canvas-controls-group">
                <button id="undo-btn" class="btn btn-outline-secondary btn-icon disabled" title="Undo (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button id="redo-btn" class="btn btn-outline-secondary btn-icon disabled" title="Redo (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>
            
            <!-- Zoom Controls -->
            <div class="canvas-controls-group">
                <button id="zoom-in-btn" class="btn btn-outline-secondary btn-icon" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button id="zoom-out-btn" class="btn btn-outline-secondary btn-icon" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="zoom-reset-btn" class="btn btn-outline-secondary btn-icon" title="Reset Zoom">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
            
            <!-- Object Controls -->
            <div class="canvas-controls-group">
                <button id="delete-btn" class="btn btn-outline-danger btn-icon" title="Delete Selected Object">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="duplicate-btn" class="btn btn-outline-secondary btn-icon" title="Duplicate Selected Object">
                    <i class="fas fa-copy"></i>
                </button>
                <button id="bring-forward-btn" class="btn btn-outline-secondary btn-icon" title="Bring Forward">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button id="send-backward-btn" class="btn btn-outline-secondary btn-icon" title="Send Backward">
                    <i class="fas fa-arrow-down"></i>
                </button>
            </div>

            <!-- Add this to your canvas controls section -->
<div class="canvas-controls-group">
    <div class="pan-controls">
        <button id="pan-up-left-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Up-Left">
            <i class="fas fa-arrow-up" style="transform: rotate(-45deg);"></i>
        </button>
        <button id="pan-up-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Up">
            <i class="fas fa-arrow-up"></i>
        </button>
        <button id="pan-up-right-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Up-Right">
            <i class="fas fa-arrow-up" style="transform: rotate(45deg);"></i>
        </button>
        <button id="pan-left-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Left">
            <i class="fas fa-arrow-left"></i>
        </button>
        <button id="pan-center-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Center Canvas">
            <i class="fas fa-bullseye"></i>
        </button>
        <button id="pan-right-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Right">
            <i class="fas fa-arrow-right"></i>
        </button>
        <button id="pan-down-left-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Down-Left">
            <i class="fas fa-arrow-down" style="transform: rotate(45deg);"></i>
        </button>
        <button id="pan-down-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Down">
            <i class="fas fa-arrow-down"></i>
        </button>
        <button id="pan-down-right-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Down-Right">
            <i class="fas fa-arrow-down" style="transform: rotate(-45deg);"></i>
        </button>
    </div>
</div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Save Design Dialog -->
<div class="dialog-overlay"></div>
<div class="save-dialog">
    <h3 class="h5 mb-3">Save Your Design</h3>
    <div class="mb-3">
        <label for="design-name" class="form-label">Design Name</label>
        <input type="text" id="design-name" class="form-control" placeholder="Enter a name for your design"
            value="{% if user_design %}{{ user_design.name }}{% else %}Untitled Design{% endif %}">
    </div>
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button id="cancel-save-btn" class="btn btn-outline-secondary">Cancel</button>
        <button id="confirm-save-btn" class="btn btn-primary">Save Design</button>
    </div>
</div>
















<!-- Hidden inputs for context data -->
<input type="hidden" id="product-type-id" value="{{ product_type.id }}">
{% if variant %}
<input type="hidden" id="variant-id" value="{{ variant.id }}">
{% endif %}
{% if template %}
<input type="hidden" id="template-id" value="{{ template.id }}">
{% else %}
No Template
{% endif %}
{% if user_design %}
<input type="hidden" id="design-id" value="{{ user_design.id }}">
{% endif %}
<!-- Use textarea for JSON -->
{% if initial_json %}
<textarea id="initial-canvas-json" style="display: none;">{{ initial_json }}</textarea>
{% endif %}



{% endblock %}











{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>




<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the canvas
        const canvas = new fabric.Canvas('design-canvas', {
            width: {{ product_type.default_width }},
            height: {{ product_type.default_height }},
            backgroundColor: 'white',
            preserveObjectStacking: true
        });

        // Keep track of current zoom level
        let zoomLevel = 1;
        
        // Variables to track the currently selected object
        let selectedObject = null;
        
        // History management for undo/redo
        const history = {
            canvasState: [],
            currentStateIndex: -1,
            undoButton: document.getElementById('undo-btn'),
            redoButton: document.getElementById('redo-btn'),
            
            saveState() {
                // Discard states after the current one when a new action is performed
                if (this.currentStateIndex < this.canvasState.length - 1) {
                    this.canvasState = this.canvasState.slice(0, this.currentStateIndex + 1);
                }
                
                // Save current state
                this.canvasState.push(JSON.stringify(canvas.toJSON()));
                this.currentStateIndex = this.canvasState.length - 1;
                
                // Update buttons state
                this.updateButtonsState();
            },
            
            undo() {
                if (this.currentStateIndex > 0) {
                    this.currentStateIndex--;
                    this.loadState();
                }
            },
            
            redo() {
                if (this.currentStateIndex < this.canvasState.length - 1) {
                    this.currentStateIndex++;
                    this.loadState();
                }
            },
            
            loadState() {
                canvas.loadFromJSON(this.canvasState[this.currentStateIndex], function() {
                    canvas.renderAll();
                });
                
                this.updateButtonsState();
            },
            
            updateButtonsState() {
                // Enable/disable undo button
                if (this.currentStateIndex > 0) {
                    this.undoButton.classList.remove('disabled');
                } else {
                    this.undoButton.classList.add('disabled');
                }
                
                // Enable/disable redo button
                if (this.currentStateIndex < this.canvasState.length - 1) {
                    this.redoButton.classList.remove('disabled');
                } else {
                    this.redoButton.classList.add('disabled');
                }
            }
        };
        
        // Initialize history with current state
        history.saveState();
        
        // Bind undo/redo buttons
        document.getElementById('undo-btn').addEventListener('click', function() {
            history.undo();
        });
        
        document.getElementById('redo-btn').addEventListener('click', function() {
            history.redo();
        });

        // Create mobile tooltip element
        const mobileTooltip = document.createElement('div');
        mobileTooltip.className = 'mobile-tooltip';
        document.body.appendChild(mobileTooltip);
        
        // Check if we're on mobile
        const isMobile = window.innerWidth <= 768;
        
        // Get elements for mobile optimization
        const sidebar = document.getElementById('design-sidebar');
        const toggleSidebarBtn = document.getElementById('toggle-sidebar');
        const canvasContainer = document.querySelector('.canvas-container');
        const tabLinks = document.querySelectorAll('.design-tabs a');
        
        // Initialize mobile view if needed
        if (isMobile) {
            // Add mobile-specific elements
            setupMobileControls();
            
            // Update toggle button icon
            if (toggleSidebarBtn) {
                toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
            
            // Set initial states
            sidebar.classList.add('collapsed');
            document.body.classList.add('mobile-view');
        }
        
        // Enhanced sidebar toggle for mobile
        if (toggleSidebarBtn) {
            toggleSidebarBtn.addEventListener('click', function() {
                if (sidebar.classList.contains('collapsed')) {
                    // Expand from hidden
                    sidebar.classList.remove('collapsed');
                    sidebar.classList.remove('expanded');
                    this.innerHTML = '<i class="fas fa-chevron-left"></i>';
                    showMobileTooltip('Sidebar visible');
                } else if (sidebar.classList.contains('expanded')) {
                    // Collapse from expanded
                    sidebar.classList.remove('expanded');
                    this.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    showMobileTooltip('Sidebar collapsed');
                } else {
                    // Toggle between normal and expanded
                    sidebar.classList.toggle('expanded');
                    if (sidebar.classList.contains('expanded')) {
                        this.innerHTML = '<i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>';
                        showMobileTooltip('Sidebar expanded');
                    } else {
                        this.innerHTML = '<i class="fas fa-chevron-right"></i>';
                        showMobileTooltip('Sidebar collapsed');
                    }
                }
            });
        }
        
        // Handle tab clicks on mobile
        tabLinks.forEach(link => {
            link.addEventListener('click', function(e) {
                // Normal tab activation logic
                const targetId = this.getAttribute('data-target');
                
                // Deactivate all tabs and contents
                tabLinks.forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                // Activate current tab and content
                this.classList.add('active');
                document.getElementById(targetId).classList.add('active');
                
                // Mobile-specific behavior
                if (isMobile && !sidebar.classList.contains('expanded')) {
                    // When sidebar is collapsed, expand it when a tab is clicked
                    sidebar.classList.add('expanded');
                    if (toggleSidebarBtn) {
                        toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-left"></i><i class="fas fa-chevron-left"></i>';
                    }
                    
                    // Show tooltip for what tab was opened
                    const tabName = this.querySelector('span').textContent;
                    showMobileTooltip(`${tabName} panel opened`);
                }
            });
        });

        // Add text to canvas
        const addTextBtn = document.getElementById('add-text-btn');
        const textInput = document.getElementById('text-input');

        addTextBtn.addEventListener('click', function () {
            if (!textInput.value.trim()) return;

            const text = new fabric.IText(textInput.value.trim(), {
                left: canvas.width / 2,
                top: canvas.height / 2,
                fontFamily: 'Arial',
                fontSize: 30,
                fill: '#000000',
                textAlign: 'center',
                originX: 'center',
                originY: 'center'
            });

            canvas.add(text);
            canvas.setActiveObject(text);
            text.enterEditing();
            canvas.renderAll();
            
            // Save state for undo/redo
            history.saveState();

            // Clear the input
            textInput.value = '';

            // Update the controls
            updateTextControls(text);
        });

        // Font family change
        const fontFamilySelect = document.getElementById('font-family');
        fontFamilySelect.addEventListener('change', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set('fontFamily', this.value);
                canvas.renderAll();
                history.saveState();
            }
        });

        // Font size change
        const fontSizeRange = document.getElementById('font-size');
        const fontSizeValue = document.getElementById('font-size-value');

        fontSizeRange.addEventListener('input', function () {
            fontSizeValue.value = this.value;
            updateTextProperty('fontSize', parseInt(this.value));
        });
        
        fontSizeRange.addEventListener('change', function() {
            // Only save state when slider interaction is complete
            history.saveState();
        });

        fontSizeValue.addEventListener('input', function () {
            fontSizeRange.value = this.value;
            updateTextProperty('fontSize', parseInt(this.value));
        });
        
        fontSizeValue.addEventListener('change', function() {
            history.saveState();
        });

        // Text color change
        const textColorInput = document.getElementById('text-color');
        textColorInput.addEventListener('input', function () {
            updateTextProperty('fill', this.value);
        });
        
        textColorInput.addEventListener('change', function() {
            history.saveState();
        });

        // Color swatches
        const colorSwatches = document.querySelectorAll('.color-swatch');
        colorSwatches.forEach(swatch => {
            swatch.addEventListener('click', function () {
                const color = this.getAttribute('data-color');
                textColorInput.value = color;
                updateTextProperty('fill', color);
                history.saveState();
            });
        });

        // Text style buttons
        const boldBtn = document.getElementById('bold-btn');
        boldBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                const isBold = activeObject.fontWeight === 'bold';
                activeObject.set('fontWeight', isBold ? 'normal' : 'bold');

                // Toggle button active state
                this.classList.toggle('active');

                canvas.renderAll();
                history.saveState();
            }
        });

        const italicBtn = document.getElementById('italic-btn');
        italicBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                const isItalic = activeObject.fontStyle === 'italic';
                activeObject.set('fontStyle', isItalic ? 'normal' : 'italic');

                // Toggle button active state
                this.classList.toggle('active');

                canvas.renderAll();
                history.saveState();
            }
        });

        const underlineBtn = document.getElementById('underline-btn');
        underlineBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                const isUnderlined = activeObject.underline;
                activeObject.set('underline', !isUnderlined);

                // Toggle button active state
                this.classList.toggle('active');

                canvas.renderAll();
                history.saveState();
            }
        });

        // Text alignment buttons
        const alignLeftBtn = document.getElementById('align-left-btn');
        alignLeftBtn.addEventListener('click', function () {
            updateTextProperty('textAlign', 'left');
            updateAlignmentButtons('left');
            history.saveState();
        });

        const alignCenterBtn = document.getElementById('align-center-btn');
        alignCenterBtn.addEventListener('click', function () {
            updateTextProperty('textAlign', 'center');
            updateAlignmentButtons('center');
            history.saveState();
        });

        const alignRightBtn = document.getElementById('align-right-btn');
        alignRightBtn.addEventListener('click', function () {
            updateTextProperty('textAlign', 'right');
            updateAlignmentButtons('right');
            history.saveState();
        });

        function updateAlignmentButtons(alignment) {
            alignLeftBtn.classList.remove('active');
            alignCenterBtn.classList.remove('active');
            alignRightBtn.classList.remove('active');

            if (alignment === 'left') alignLeftBtn.classList.add('active');
            if (alignment === 'center') alignCenterBtn.classList.add('active');
            if (alignment === 'right') alignRightBtn.classList.add('active');
        }

        // Upload images
        const imageUpload = document.getElementById('image-upload');
        const uploadPreview = document.getElementById('upload-preview');
        const uploadPreviewImg = document.getElementById('upload-preview-img');
        const addUploadBtn = document.getElementById('add-upload-btn');

        imageUpload.addEventListener('change', function (e) {
            if (this.files && this.files[0]) {
                const file = this.files[0];

                // Validate file size (5MB max)
                if (file.size > 5 * 1024 * 1024) {
                    alert('File size exceeds 5MB limit.');
                    return;
                }

                const reader = new FileReader();
                reader.onload = function (e) {
                    uploadPreviewImg.src = e.target.result;
                    uploadPreview.classList.remove('d-none');
                };
                reader.readAsDataURL(file);
            }
        });

        addUploadBtn.addEventListener('click', function () {
            const imageUrl = uploadPreviewImg.src;

            // Show loading indicator
            document.querySelector('.loading-overlay').classList.add('active');

            fabric.Image.fromURL(imageUrl, function (img) {
                // Scale image to fit within the canvas (max 40% of canvas size)
                const maxWidth = canvas.width * 0.4;
                const maxHeight = canvas.height * 0.4;

                if (img.width > maxWidth || img.height > maxHeight) {
                    const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);
                    img.scale(scaleFactor);
                }

                // Center the image
                img.set({
                    left: canvas.width / 2,
                    top: canvas.height / 2,
                    originX: 'center',
                    originY: 'center'
                });

                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();
                history.saveState();

                // Reset the upload input and preview
                imageUpload.value = '';
                uploadPreview.classList.add('d-none');

                // Hide loading indicator
                document.querySelector('.loading-overlay').classList.remove('active');
            });
        });

        // Product variant selection
        const variantOptions = document.querySelectorAll('.variant-option');
        variantOptions.forEach(option => {
            option.addEventListener('click', function () {
                const variantId = this.getAttribute('data-variant-id');

                // Update hidden input
                document.getElementById('variant-id').value = variantId;

                // Update visual selection
                variantOptions.forEach(opt => opt.classList.remove('active'));
                this.classList.add('active');

                // TODO: Update product image background if needed
                // This would require an AJAX call to get the variant data
            });
        });

        // Canvas background settings
        const canvasBackgroundSelect = document.getElementById('canvas-background');
        const customBgColorContainer = document.getElementById('custom-bg-color-container');
        const customBgColorInput = document.getElementById('custom-bg-color');

        canvasBackgroundSelect.addEventListener('change', function () {
            const value = this.value;

            if (value === 'custom') {
                customBgColorContainer.classList.remove('d-none');
                canvas.setBackgroundColor(customBgColorInput.value, canvas.renderAll.bind(canvas));
            } else {
                customBgColorContainer.classList.add('d-none');

                if (value === 'transparent') {
                    canvas.setBackgroundColor('', canvas.renderAll.bind(canvas));
                } else if (value === 'white') {
                    canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
                } else if (value === 'product') {
                    // TODO: Set background to match product color if available
                    canvas.setBackgroundColor('#f0f0f0', canvas.renderAll.bind(canvas));
                }
            }
            history.saveState();
        });

        customBgColorInput.addEventListener('input', function () {
            canvas.setBackgroundColor(this.value, canvas.renderAll.bind(canvas));
        });
        
        customBgColorInput.addEventListener('change', function() {
            history.saveState();
        });

        // Show/hide print area
        const showPrintAreaCheck = document.getElementById('show-print-area');
        if (showPrintAreaCheck) {
            showPrintAreaCheck.addEventListener('change', function () {
                // TODO: Implement print area visualization
            });
        }

        // Zoom controls
        const zoomInBtn = document.getElementById('zoom-in-btn');
        const zoomOutBtn = document.getElementById('zoom-out-btn');
        const zoomResetBtn = document.getElementById('zoom-reset-btn');

        zoomInBtn.addEventListener('click', function () {
            if (zoomLevel < 3) {
                zoomLevel += 0.1;
                updateZoom();
            }
        });

        zoomOutBtn.addEventListener('click', function () {
            if (zoomLevel > 0.5) {
                zoomLevel -= 0.1;
                updateZoom();
            }
        });

        zoomResetBtn.addEventListener('click', function () {
            zoomLevel = 1;
            updateZoom();
        });

        function updateZoom() {
            canvas.setZoom(zoomLevel);
            canvas.setWidth({{ product_type.default_width }} * zoomLevel);
            canvas.setHeight({{ product_type.default_height }} * zoomLevel);
            canvas.renderAll();
        }

        // Pan controls
        const panStep = 50; // pixels to move per pan action

        document.getElementById('pan-up-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(0, -panStep)); // Negative Y to move up
            canvas.renderAll();
        });

        document.getElementById('pan-down-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(0, panStep)); // Positive Y to move down
            canvas.renderAll();
        });

        document.getElementById('pan-left-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(-panStep, 0)); // Negative X to move left
            canvas.renderAll();
        });

        document.getElementById('pan-right-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(panStep, 0)); // Positive X to move right
            canvas.renderAll();
        });

        document.getElementById('pan-up-left-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(-panStep, -panStep)); // Move up-left
            canvas.renderAll();
        });

        document.getElementById('pan-up-right-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(panStep, -panStep)); // Move up-right
            canvas.renderAll();
        });

        document.getElementById('pan-down-left-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(-panStep, panStep)); // Move down-left
            canvas.renderAll();
        });

        document.getElementById('pan-down-right-btn').addEventListener('click', function() {
            canvas.relativePan(new fabric.Point(panStep, panStep)); // Move down-right
            canvas.renderAll();
        });

        // Object manipulation
        const deleteBtn = document.getElementById('delete-btn');
        deleteBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.remove(activeObject);
                canvas.renderAll();
                history.saveState();
            }
        });

        const duplicateBtn = document.getElementById('duplicate-btn');
        duplicateBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                // Clone the object
                activeObject.clone(function (cloned) {
                    // Offset the position slightly
                    cloned.set({
                        left: cloned.left + 10,
                        top: cloned.top + 10,
                        evented: true,
                    });

                    canvas.add(cloned);
                    canvas.setActiveObject(cloned);
                    canvas.renderAll();
                    history.saveState();
                });
            }
        });

        const bringForwardBtn = document.getElementById('bring-forward-btn');
        bringForwardBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.bringForward(activeObject);
                canvas.renderAll();
                history.saveState();
            }
        });

        const sendBackwardBtn = document.getElementById('send-backward-btn');
        sendBackwardBtn.addEventListener('click', function () {
            const activeObject = canvas.getActiveObject();
            if (activeObject) {
                canvas.sendBackwards(activeObject);
                canvas.renderAll();
                history.saveState();
            }
        });


        // Save design dialog
        const saveDesignBtn = document.getElementById('save-design-btn');
        const saveDialog = document.querySelector('.save-dialog');
        const dialogOverlay = document.querySelector('.dialog-overlay');
        const cancelSaveBtn = document.getElementById('cancel-save-btn');
        const confirmSaveBtn = document.getElementById('confirm-save-btn');
        const designNameInput = document.getElementById('design-name');

        saveDesignBtn.addEventListener('click', function () {
            saveDialog.classList.add('active');
            dialogOverlay.classList.add('active');
        });

        cancelSaveBtn.addEventListener('click', function () {
            saveDialog.classList.remove('active');
            dialogOverlay.classList.remove('active');
        });

        dialogOverlay.addEventListener('click', function () {
            saveDialog.classList.remove('active');
            dialogOverlay.classList.remove('active');
        });

        confirmSaveBtn.addEventListener('click', function () {
            const designName = designNameInput.value.trim() || 'Untitled Design';

            // Show loading indicator
            document.querySelector('.loading-overlay').classList.add('active');
            saveDialog.classList.remove('active');
            dialogOverlay.classList.remove('active');

            // Generate a preview image
            const dataURL = canvas.toDataURL({
                format: 'png',
                quality: 0.8
            });

            // Prepare the data to save
            const saveData = {
                name: designName,
                canvas_json: JSON.stringify(canvas.toJSON()),
                preview_image: dataURL,
                product_type_id: document.getElementById('product-type-id').value,
                is_draft: true
            };

            // Add variant_id if available
            const variantIdElement = document.getElementById('variant-id');
            if (variantIdElement && variantIdElement.value) {
                saveData.variant_id = variantIdElement.value;
            }

            // Add template_id if available
            const templateIdElement = document.getElementById('template-id');
            if (templateIdElement && templateIdElement.value) {
                saveData.template_id = templateIdElement.value;
            }

            // Add design_id if editing existing design
            const designIdElement = document.getElementById('design-id');
            if (designIdElement && designIdElement.value) {
                saveData.design_id = designIdElement.value;
            }

            // Get CSRF token
            const csrfToken = getCsrfToken();

            // Send the data to the server
            fetch('{% url "save_design" %}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify(saveData)
            })
                .then(response => response.json())
                .then(data => {
                    document.querySelector('.loading-overlay').classList.remove('active');

                    if (data.success) {
                        // Update design_id if it's a new design
                        if (!designIdElement || !designIdElement.value) {
                            const hiddenInput = document.createElement('input');
                            hiddenInput.type = 'hidden';
                            hiddenInput.id = 'design-id';
                            hiddenInput.value = data.design_id;
                            document.body.appendChild(hiddenInput);
                        }

                        if (data.redirect_url) {
                        console.log("Redirect URL found:", data.redirect_url);
                        console.log("Redirecting...");
                        window.location.href = data.redirect_url;
                        return;
                    } else {
                        console.log("No redirect URL in response");
                    }

                    

                        alert('Design saved successfully!');
                    } else {
                        alert('Error saving design: ' + data.error);
                    }
                })




.catch(error => {
    document.querySelector('.loading-overlay').classList.remove('active');
    console.error('Error:', error);
    
    // Check if error might be related to authentication or HTML redirect
    if (error.name === 'SyntaxError' && 
        error.message.includes('Unexpected token') && 
        error.message.includes('<!doctype')) {
        
        console.log("Detected login redirect, navigating to login page...");
        const currentUrl = encodeURIComponent(window.location.href);
        window.location.href = '/auth/login/?next=' + currentUrl;
    } else {
        alert('Error saving design. Please try again.');
    }
});



        });



        // Helper function to get CSRF token
        function getCsrfToken() {
            const cookieValue = document.cookie
                .split('; ')
                .find(row => row.startsWith('csrftoken='))
                ?.split('=')[1];

            return cookieValue || '';
        }

        // Selection events
        canvas.on('selection:created', updateControlsFromSelection);
        canvas.on('selection:updated', updateControlsFromSelection);
        canvas.on('selection:cleared', function () {
            // Reset controls or disable them
            fontFamilySelect.disabled = true;
            fontSizeRange.disabled = true;
            fontSizeValue.disabled = true;
            textColorInput.disabled = true;

            // Reset buttons
            boldBtn.classList.remove('active');
            italicBtn.classList.remove('active');
            underlineBtn.classList.remove('active');

            alignLeftBtn.classList.remove('active');
            alignCenterBtn.classList.remove('active');
            alignRightBtn.classList.remove('active');
        });

        function updateControlsFromSelection(e) {
            const activeObject = e.selected[0];

            if (activeObject && activeObject.type === 'i-text') {
                updateTextControls(activeObject);
            } else {
                // Not a text object, disable text controls
                fontFamilySelect.disabled = true;
                fontSizeRange.disabled = true;
                fontSizeValue.disabled = true;
                textColorInput.disabled = true;

                // Reset button states
                boldBtn.classList.remove('active');
                italicBtn.classList.remove('active');
                underlineBtn.classList.remove('active');

                alignLeftBtn.classList.remove('active');
                alignCenterBtn.classList.remove('active');
                alignRightBtn.classList.remove('active');
            }
        }

        function updateTextControls(textObject) {
            // Enable controls
            fontFamilySelect.disabled = false;
            fontSizeRange.disabled = false;
            fontSizeValue.disabled = false;
            textColorInput.disabled = false;

            // Update values
            fontFamilySelect.value = textObject.fontFamily;
            fontSizeRange.value = textObject.fontSize;
            fontSizeValue.value = textObject.fontSize;
            textColorInput.value = textObject.fill;

            // Update button states
            boldBtn.classList.toggle('active', textObject.fontWeight === 'bold');
            italicBtn.classList.toggle('active', textObject.fontStyle === 'italic');
            underlineBtn.classList.toggle('active', textObject.underline === true);

            // Update alignment
            updateAlignmentButtons(textObject.textAlign);
        }

        function updateTextProperty(property, value) {
            const activeObject = canvas.getActiveObject();
            if (activeObject && activeObject.type === 'i-text') {
                activeObject.set(property, value);
                canvas.renderAll();
            }
        }

        // Handle object modifications
        canvas.on('object:modified', function() {
            history.saveState();
        });
        
        // Handle keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Undo: Ctrl+Z
            if (e.key === 'z' && (e.ctrlKey || e.metaKey) && !e.shiftKey) {
                history.undo();
                e.preventDefault();
            }
            
            // Redo: Ctrl+Y or Ctrl+Shift+Z
            if ((e.key === 'y' && (e.ctrlKey || e.metaKey)) || 
                (e.key === 'z' && (e.ctrlKey || e.metaKey) && e.shiftKey)) {
                history.redo();
                e.preventDefault();
            }
            
            // Only process other shortcuts if not typing in a text field
            if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                // Delete key for delete
                if (e.key === 'Delete' || e.key === 'Backspace') {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject) {
                        canvas.remove(activeObject);
                        canvas.renderAll();
                        history.saveState();
                        e.preventDefault();
                    }
                }
                
                // Ctrl+D for duplicate
                if (e.key === 'd' && (e.ctrlKey || e.metaKey)) {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject) {
                        activeObject.clone(function (cloned) {
                            cloned.set({
                                left: cloned.left + 10,
                                top: cloned.top + 10,
                                evented: true,
                            });
                            canvas.add(cloned);
                            canvas.setActiveObject(cloned);
                            canvas.renderAll();
                            history.saveState();
                        });
                        e.preventDefault();
                    }
                }
                
                // Arrow keys for moving objects
                if (e.key.startsWith('Arrow')) {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject) {
                        const moveStep = e.shiftKey ? 10 : 1;
                        
                        switch(e.key) {
                            case 'ArrowUp':
                                activeObject.top -= moveStep;
                                break;
                            case 'ArrowDown':
                                activeObject.top += moveStep;
                                break;
                            case 'ArrowLeft':
                                activeObject.left -= moveStep;
                                break;
                            case 'ArrowRight':
                                activeObject.left += moveStep;
                                break;
                        }
                        
                        activeObject.setCoords();
                        canvas.renderAll();
                        
                        if (e.shiftKey) { // Only save state on larger moves to avoid history spam
                            history.saveState();
                        }
                        
                        e.preventDefault();
                    }
                }
            }
        });

        // Load initial canvas state if available
        const initialCanvasJSON = document.getElementById('initial-canvas-json');
        if (initialCanvasJSON && initialCanvasJSON.value) {
            try {
                console.log("Loading template from JSON");
                // Parse the JSON string into an object first
                const canvasData = JSON.parse(initialCanvasJSON.value);
                
                // Now load the JSON object into the canvas
                canvas.loadFromJSON(canvasData, function() {
                    canvas.renderAll();
                    console.log("Canvas template loaded successfully");
                    
                    // Select first object if available
                    if (canvas.getObjects().length > 0) {
                        canvas.setActiveObject(canvas.getObjects()[0]);
                        canvas.renderAll();
                    }
                    
                    // Initialize history with the loaded template
                    history.saveState();
                });
            } catch (error) {
                console.error('Error loading initial canvas:', error);
                console.error('JSON string preview:', initialCanvasJSON.value.substring(0, 100) + '...');
            }
        }

        // Initialize with product image if available
        const productImage = document.getElementById('product-image');
        if (productImage) {
            // Product image is loaded
            console.log("Product image found");
        }
        
        // Add responsiveness to canvas container
        window.addEventListener('resize', function() {
            adjustCanvasContainerSize();
            
            // Check if mobile view should be enabled/disabled
            const isMobileNow = window.innerWidth <= 768;
            
            if (isMobileNow && !document.body.classList.contains('mobile-view')) {
                document.body.classList.add('mobile-view');
                setupMobileControls();
            } else if (!isMobileNow && document.body.classList.contains('mobile-view')) {
                document.body.classList.remove('mobile-view');
                
                // Reset sidebar state
                sidebar.classList.remove('expanded');
                sidebar.classList.remove('collapsed');
                
                // Reset canvas container
                canvasContainer.style.marginLeft = '';
                canvasContainer.style.width = '';
            }
        });
        
        function adjustCanvasContainerSize() {
            const canvasContainer = document.querySelector('.canvas-container');
            const editorContainer = document.querySelector('.editor-container');
            
            if (canvasContainer && editorContainer) {
                // Make sure canvas container adapts to available space
                console.log("Adjusting canvas container size");
            }
        }
        
        // Setup mobile-specific controls
        function setupMobileControls() {
            // Create fullscreen toggle button if it doesn't exist
            if (!document.getElementById('fullscreen-btn')) {
                const fullscreenBtn = document.createElement('button');
                fullscreenBtn.id = 'fullscreen-btn';
                fullscreenBtn.className = 'btn btn-outline-secondary btn-icon btn-fullscreen';
                fullscreenBtn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
                fullscreenBtn.title = 'Toggle Fullscreen';
                
                // Add to canvas controls
                const canvasControls = document.querySelector('.canvas-controls');
                if (canvasControls) {
                    const newGroup = document.createElement('div');
                    newGroup.className = 'canvas-controls-group';
                    newGroup.appendChild(fullscreenBtn);
                    canvasControls.appendChild(newGroup);
                }
                
                // Add fullscreen toggle functionality
                fullscreenBtn.addEventListener('click', function() {
                    document.body.classList.toggle('fullscreen-mode');
                    sidebar.classList.toggle('collapsed');
                    
                    if (document.body.classList.contains('fullscreen-mode')) {
                        this.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
                        showMobileTooltip('Fullscreen mode');
                    } else {
                        this.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
                        showMobileTooltip('Normal mode');
                    }
                });
            }
            
            // Create pan controls toggle
            const panControls = document.querySelector('.pan-controls');
            if (panControls) {
                const panToggleBtn = document.createElement('button');
                panToggleBtn.id = 'pan-toggle-btn';
                panToggleBtn.className = 'btn btn-outline-secondary btn-icon';
                panToggleBtn.innerHTML = '<i class="fas fa-arrows-alt"></i>';
                panToggleBtn.title = 'Toggle Pan Controls';
                
                // Insert before the pan controls
                panControls.parentNode.insertBefore(panToggleBtn, panControls);
                
                // Toggle pan controls visibility
                panToggleBtn.addEventListener('click', function() {
                    panControls.classList.toggle('active');
                    if (panControls.classList.contains('active')) {
                        showMobileTooltip('Pan controls visible');
                    } else {
                        showMobileTooltip('Pan controls hidden');
                    }
                });
            }
            
            // Add canvas controls toggle
            const canvasControls = document.querySelector('.canvas-controls');
            if (canvasControls) {
                const canvasControlsToggle = document.createElement('button');
                canvasControlsToggle.className = 'canvas-controls-toggle';
                canvasControlsToggle.innerHTML = '<i class="fas fa-sliders-h"></i>';
                document.body.appendChild(canvasControlsToggle);
                
                // Store original position to restore later
                const originalPosition = {
                    bottom: canvasControls.style.bottom,
                    right: canvasControls.style.right
                };
                
                // Toggle canvas controls visibility
                canvasControlsToggle.addEventListener('click', function() {
                    if (canvasControls.style.display === 'none') {
                        canvasControls.style.display = 'flex';
                        this.innerHTML = '<i class="fas fa-times"></i>';
                        showMobileTooltip('Controls visible');
                    } else {
                        canvasControls.style.display = 'none';
                        this.innerHTML = '<i class="fas fa-sliders-h"></i>';
                        showMobileTooltip('Controls hidden');
                    }
                });
            }
            
            // Add touch gesture support for panning
            if (canvasContainer) {
                let touching = false;
                let lastX = 0;
                let lastY = 0;
                
                canvasContainer.addEventListener('touchstart', function(e) {
                    // Only if we have 2 fingers (to distinguish from object manipulation)
                    if (e.touches.length === 2) {
                        touching = true;
                        lastX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                        lastY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                        e.preventDefault(); // Prevent default to avoid scrolling
                    }
                });
                
                canvasContainer.addEventListener('touchmove', function(e) {
                    if (touching && e.touches.length === 2) {
                        // Calculate average position of both touches
                        const currentX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                        const currentY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                        
                        // Calculate delta
                        const deltaX = currentX - lastX;
                        const deltaY = currentY - lastY;
                        
                        // Pan the canvas
                        canvas.relativePan(new fabric.Point(deltaX, deltaY));
                        
                        // Update last positions
                        lastX = currentX;
                        lastY = currentY;
                        
                        e.preventDefault(); // Prevent default to avoid scrolling
                    }
                });
                
                canvasContainer.addEventListener('touchend', function() {
                    touching = false;
                });
            }
        }
        
        // Show a temporary mobile tooltip
        function showMobileTooltip(message) {
            mobileTooltip.textContent = message;
            mobileTooltip.classList.add('visible');
            
            // Hide after 2 seconds
            setTimeout(() => {
                mobileTooltip.classList.remove('visible');
            }, 2000);
        }
        
        // Call once on init
        adjustCanvasContainerSize();
    });
</script>
{% endblock %}