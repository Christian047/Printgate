{% extends 'base1.html' %}
{% load static %}

{% block title %}Design Editor - {{ product_type.name }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<style>
    :root {
        --sidebar-width: 260px;
        --header-height: 60px;
        --footer-height: 50px;
    }

    .design-editor {
        display: flex;
        flex-direction: column;
        height: calc(100vh - var(--header-height));
        overflow: hidden;
    }

    .editor-container {
        display: flex;
        flex: 1;
        overflow: hidden;
    }

    .design-sidebar {
        width: var(--sidebar-width);
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        overflow: hidden;
    }

    .sidebar-nav {
        background-color: #f0f0f0;
        border-bottom: 1px solid #dee2e6;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .design-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .design-tabs li {
        flex: 1;
        text-align: center;
    }

    .design-tabs a {
        display: block;
        padding: 12px 8px;
        color: #495057;
        text-decoration: none;
        border-bottom: 2px solid transparent;
        font-size: 14px;
        transition: all 0.2s;
    }

    .design-tabs a.active {
        background-color: #fff;
        border-bottom-color: #0d6efd;
        color: #0d6efd;
    }

    .design-tabs a:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .design-tabs i {
        margin-right: 6px;
    }

    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        overflow: auto;
        position: relative;
    }

    #design-canvas {
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .canvas-wrapper {
        position: relative;
    }

    .editor-header {
        display: flex;
        align-items: center;
        height: var(--header-height);
        padding: 0 15px;
        background-color: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    .editor-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: var(--footer-height);
        padding: 0 15px;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
    }

    .control-section {
        margin-bottom: 24px;
    }

    .control-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #dee2e6;
    }

    .control-row {
        display: flex;
        margin-bottom: 8px;
        gap: 8px;
    }

    .control-item {
        flex: 1;
    }

    .btn-group {
        display: flex;
        gap: 4px;
    }

    .color-swatch {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    .asset-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 10px;
        margin-top: 10px;
    }

    .asset-item {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 5px;
        cursor: pointer;
        background-color: #fff;
        text-align: center;
        transition: all 0.2s;
    }

    .asset-item:hover {
        border-color: #0d6efd;
        transform: translateY(-2px);
        box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
    }

    .asset-item img {
        max-width: 100%;
        max-height: 80px;
        object-fit: contain;
    }

    .variant-options {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
    }

    .variant-option {
        border: 2px solid #dee2e6;
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        overflow: hidden;
    }

    .variant-option.active {
        border-color: #0d6efd;
    }

    .variant-option img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    .zoom-controls {
        position: absolute;
        bottom: 15px;
        right: 15px;
        display: flex;
        gap: 5px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 5px;
        border-radius: 4px;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
    }

    /* Target specific button for consistency */
    .btn-icon {
        width: 34px;
        height: 34px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    /* Hide content until it's active */
    .tab-content:not(.active) {
        display: none;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .loading-overlay.active {
        visibility: visible;
        opacity: 1;
    }

    /* Save Design Dialog */
    .save-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        width: 400px;
        max-width: 90vw;
        display: none;
    }

    .save-dialog.active {
        display: block;
    }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .dialog-overlay.active {
        display: block;
    }
</style>
{% endblock %}

{% block content %}
<div class="design-editor">
    <!-- Editor Header -->
    <div class="editor-header">
        <div class="d-flex align-items-center flex-grow-1">
            <a href="{% url 'designs:home' %}" class="btn btn-outline-secondary me-3">
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="h5 mb-0">{{ product_type.name }} Designer</h1>

            {% if template %}
            <span class="badge bg-secondary ms-2">Template: {{ template.name }}</span>
            {% endif %}
        </div>

        <div>
            <button id="save-design-btn" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Save Design
            </button>
        </div>
    </div>

    <!-- Main Editor Area -->
    <div class="editor-container">
        <!-- Sidebar -->
        <div class="design-sidebar">
            <div class="sidebar-nav">
                <ul class="design-tabs">
                    <li>
                        <a href="#" class="active" data-target="tab-text">
                            <i class="fas fa-font"></i> Text
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-clipart">
                            <i class="fas fa-image"></i> Images
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-upload">
                            <i class="fas fa-upload"></i> Upload
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-product">
                            <i class="fas fa-tshirt"></i> Product
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-content">
                <!-- Text Tab -->
                <div class="tab-content active" id="tab-text">
                    <div class="control-section">
                        <h3>Add Text</h3>
                        <div class="form-group mb-3">
                            <textarea id="text-input" class="form-control" rows="2"
                                placeholder="Enter your text here..."></textarea>
                        </div>
                        <button id="add-text-btn" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-1"></i> Add Text
                        </button>
                    </div>

                    <div class="control-section">
                        <h3>Text Properties</h3>
                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-family" class="form-label">Font</label>
                                <select id="font-family" class="form-select">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    {% for font in fonts %}
                                    <option value="{{ font.name }}">{{ font.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-size" class="form-label">Size</label>
                                <input type="range" class="form-range" id="font-size" min="8" max="120" value="30">
                            </div>
                            <div class="control-item text-center">
                                <label class="form-label">Size Value</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="font-size-value" min="8" max="120"
                                        value="30">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">Text Color</label>
                                <input type="color" class="form-control form-control-color w-100" id="text-color"
                                    value="#000000">
                            </div>
                            <div class="control-item">
                                <label class="form-label">Common Colors</label>
                                <div class="d-flex flex-wrap gap-1">
                                    <div class="color-swatch" style="background-color: #000000" data-color="#000000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ffffff" data-color="#ffffff">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ff0000" data-color="#ff0000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #0000ff" data-color="#0000ff">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">Style</label>
                                <div class="btn-group w-100">
                                    <button id="bold-btn" class="btn btn-outline-secondary btn-icon" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button id="italic-btn" class="btn btn-outline-secondary btn-icon" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button id="underline-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label class="form-label">Alignment</label>
                                <div class="btn-group w-100">
                                    <button id="align-left-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button id="align-center-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button id="align-right-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Clipart/Images Tab -->
                <div class="tab-content" id="tab-clipart">
                    <div class="control-section">
                        <h3>Add Clipart</h3>
                        <div class="form-group mb-3">
                            <input type="text" id="clipart-search" class="form-control" placeholder="Search clipart...">
                        </div>

                        <div class="asset-grid">
                            {% for asset in clipart %}
                            <div class="asset-item" data-asset-id="{{ asset.id }}"
                                data-asset-url="{{ asset.image.url }}">
                                <img src="{{ asset.image.url }}" alt="{{ asset.name }}">
                            </div>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div class="tab-content" id="tab-upload">
                    <div class="control-section">
                        <h3>Upload Your Image</h3>
                        <p class="text-muted small">Supported formats: PNG, JPG, SVG (max 5MB)</p>

                        <div class="mb-3">
                            <input type="file" id="image-upload" class="form-control" accept="image/*">
                        </div>

                        <div id="upload-preview" class="text-center mt-3 d-none">
                            <img id="upload-preview-img" src="" alt="Preview" class="img-fluid border rounded">
                            <button id="add-upload-btn" class="btn btn-primary mt-2 w-100">
                                <i class="fas fa-plus me-1"></i> Add to Design
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Tab -->
                <div class="tab-content" id="tab-product">
                    <div class="control-section">
                        <h3>Product Options</h3>

                        {% if all_variants %}
                        <div class="mb-3">
                            <label class="form-label">Color/Variant</label>
                            <div class="variant-options">
                                {% for v in all_variants %}
                                <div class="variant-option {% if variant.id == v.id %}active{% endif %}"
                                    data-variant-id="{{ v.id }}">
                                    {% if v.color_hex %}
                                    <div style="background-color: {{ v.color_hex }}; width: 100%; height: 100%;"></div>
                                    {% else %}
                                    <img src="{{ v.base_image.url }}" alt="{{ v.name }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product_type.has_print_area %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="show-print-area" checked>
                            <label class="form-check-label" for="show-print-area">
                                Show Print Area
                            </label>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">Canvas Background</label>
                            <select id="canvas-background" class="form-select">
                                <option value="transparent">Transparent</option>
                                <option value="white" selected>White</option>
                                <option value="product">Product Color</option>
                                <option value="custom">Custom Color</option>
                            </select>
                        </div>

                        <div id="custom-bg-color-container" class="mb-3 d-none">
                            <label class="form-label">Custom Background Color</label>
                            <input type="color" id="custom-bg-color" class="form-control form-control-color w-100"
                                value="#ffffff">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <div id="product-background">
                    {% if variant %}
                    <img src="{{ variant.base_image.url }}" alt="{{ variant.name }}" id="product-image"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">
                    {% endif %}
                </div>
                <canvas id="design-canvas"></canvas>
            </div>

            <div class="zoom-controls">
                <button id="zoom-in-btn" class="btn btn-outline-secondary btn-icon" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button id="zoom-out-btn" class="btn btn-outline-secondary btn-icon" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="zoom-reset-btn" class="btn btn-outline-secondary btn-icon" title="Reset Zoom">
                    <i class="fas fa-expand"></i>
                </button>
            </div>
        </div>
    </div>

    <!-- Editor Footer -->
    <div class="editor-footer">
        <div>
            <button id="delete-btn" class="btn btn-outline-danger" title="Delete Selected Object">
                <i class="fas fa-trash me-1"></i> Delete
            </button>
            <button id="duplicate-btn" class="btn btn-outline-secondary" title="Duplicate Selected Object">
                <i class="fas fa-copy me-1"></i> Duplicate
            </button>
        </div>

        <div>
            <button id="bring-forward-btn" class="btn btn-outline-secondary btn-icon" title="Bring Forward">
                <i class="fas fa-arrow-up"></i>
            </button>
            <button id="send-backward-btn" class="btn btn-outline-secondary btn-icon" title="Send Backward">
                <i class="fas fa-arrow-down"></i>
            </button>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Save Design Dialog -->
<div class="dialog-overlay"></div>
<div class="save-dialog">
    <h3 class="h5 mb-3">Save Your Design</h3>
    <div class="mb-3">
        <label for="design-name" class="form-label">Design Name</label>
        <input type="text" id="design-name" class="form-control" placeholder="Enter a name for your design"
            value="{% if user_design %}{{ user_design.name }}{% else %}Untitled Design{% endif %}">
    </div>
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button id="cancel-save-btn" class="btn btn-outline-secondary">Cancel</button>
        <button id="confirm-save-btn" class="btn btn-primary">Save Design</button>
    </div>
</div>
<hr>{{ template.id }}
<hr>
<hr>
<hr>
<!-- Hidden inputs for context data -->
<input type="hidden" id="product-type-id" value="{{ product_type.id }}">
{% if variant %}
<input type="hidden" id="variant-id" value="{{ variant.id }}">
{% endif %}
{% if template %}
<input type="hidden" id="template-id" value="{{ template.id }}">
{% else %}

No Template
{% endif %}
{% if user_design %}
<input type="hidden" id="design-id" value="{{ user_design.id }}">
{% endif %}
{% if initial_json %}
<input type="hidden" id="initial-canvas-json" value="{{ initial_json|safe }}">
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the canvas
        const canvas = new fabric.Canvas('design-canvas', {
            width: {{ product_type.default_width }},
        height: {{ product_type.default_height }},
        backgroundColor: 'white',
        preserveObjectStacking: true
        });

    // Keep track of current zoom level
    let zoomLevel = 1;

    // Variables to track the currently selected object
    let selectedObject = null;

    // Tab switching
    const tabLinks = document.querySelectorAll('.design-tabs a');
    const tabContents = document.querySelectorAll('.tab-content');

    tabLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            e.preventDefault();

            // Remove active class from all tabs
            tabLinks.forEach(tab => tab.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            // Add active class to clicked tab
            this.classList.add('active');

            // Show corresponding content
            const targetId = this.getAttribute('data-target');
            document.getElementById(targetId).classList.add('active');
        });
    });

    // Add text to canvas
    const addTextBtn = document.getElementById('add-text-btn');
    const textInput = document.getElementById('text-input');

    addTextBtn.addEventListener('click', function () {
        if (!textInput.value.trim()) return;

        const text = new fabric.IText(textInput.value.trim(), {
            left: canvas.width / 2,
            top: canvas.height / 2,
            fontFamily: 'Arial',
            fontSize: 30,
            fill: '#000000',
            textAlign: 'center',
            originX: 'center',
            originY: 'center'
        });

        canvas.add(text);
        canvas.setActiveObject(text);
        text.enterEditing();
        canvas.renderAll();

        // Clear the input
        textInput.value = '';

        // Update the controls
        updateTextControls(text);
    });

    // Font family change
    const fontFamilySelect = document.getElementById('font-family');
    fontFamilySelect.addEventListener('change', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            activeObject.set('fontFamily', this.value);
            canvas.renderAll();
        }
    });

    // Font size change
    const fontSizeRange = document.getElementById('font-size');
    const fontSizeValue = document.getElementById('font-size-value');

    fontSizeRange.addEventListener('input', function () {
        fontSizeValue.value = this.value;
        updateTextProperty('fontSize', parseInt(this.value));
    });

    fontSizeValue.addEventListener('input', function () {
        fontSizeRange.value = this.value;
        updateTextProperty('fontSize', parseInt(this.value));
    });

    // Text color change
    const textColorInput = document.getElementById('text-color');
    textColorInput.addEventListener('input', function () {
        updateTextProperty('fill', this.value);
    });

    // Color swatches
    const colorSwatches = document.querySelectorAll('.color-swatch');
    colorSwatches.forEach(swatch => {
        swatch.addEventListener('click', function () {
            const color = this.getAttribute('data-color');
            textColorInput.value = color;
            updateTextProperty('fill', color);
        });
    });

    // Text style buttons
    const boldBtn = document.getElementById('bold-btn');
    boldBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isBold = activeObject.fontWeight === 'bold';
            activeObject.set('fontWeight', isBold ? 'normal' : 'bold');

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
        }
    });

    const italicBtn = document.getElementById('italic-btn');
    italicBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isItalic = activeObject.fontStyle === 'italic';
            activeObject.set('fontStyle', isItalic ? 'normal' : 'italic');

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
        }
    });

    const underlineBtn = document.getElementById('underline-btn');
    underlineBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isUnderlined = activeObject.underline;
            activeObject.set('underline', !isUnderlined);

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
        }
    });

    // Text alignment buttons
    const alignLeftBtn = document.getElementById('align-left-btn');
    alignLeftBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'left');
        updateAlignmentButtons('left');
    });

    const alignCenterBtn = document.getElementById('align-center-btn');
    alignCenterBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'center');
        updateAlignmentButtons('center');
    });

    const alignRightBtn = document.getElementById('align-right-btn');
    alignRightBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'right');
        updateAlignmentButtons('right');
    });

    function updateAlignmentButtons(alignment) {
        alignLeftBtn.classList.remove('active');
        alignCenterBtn.classList.remove('active');
        alignRightBtn.classList.remove('active');

        if (alignment === 'left') alignLeftBtn.classList.add('active');
        if (alignment === 'center') alignCenterBtn.classList.add('active');
        if (alignment === 'right') alignRightBtn.classList.add('active');
    }

    // Clipart/Images
    const clipartItems = document.querySelectorAll('.asset-item');
    clipartItems.forEach(item => {
        item.addEventListener('click', function () {
            const assetUrl = this.getAttribute('data-asset-url');

            // Show loading indicator
            document.querySelector('.loading-overlay').classList.add('active');

            fabric.Image.fromURL(assetUrl, function (img) {
                // Scale image to fit within the canvas (max 30% of canvas size)
                const maxWidth = canvas.width * 0.3;
                const maxHeight = canvas.height * 0.3;

                if (img.width > maxWidth || img.height > maxHeight) {
                    const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);
                    img.scale(scaleFactor);
                }

                // Center the image
                img.set({
                    left: canvas.width / 2,
                    top: canvas.height / 2,
                    originX: 'center',
                    originY: 'center'
                });

                canvas.add(img);
                canvas.setActiveObject(img);
                canvas.renderAll();

                // Hide loading indicator
                document.querySelector('.loading-overlay').classList.remove('active');
            });
        });
    });

    // Upload images
    const imageUpload = document.getElementById('image-upload');
    const uploadPreview = document.getElementById('upload-preview');
    const uploadPreviewImg = document.getElementById('upload-preview-img');
    const addUploadBtn = document.getElementById('add-upload-btn');

    imageUpload.addEventListener('change', function (e) {
        if (this.files && this.files[0]) {
            const file = this.files[0];

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size exceeds 5MB limit.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                uploadPreviewImg.src = e.target.result;
                uploadPreview.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    addUploadBtn.addEventListener('click', function () {
        const imageUrl = uploadPreviewImg.src;

        // Show loading indicator
        document.querySelector('.loading-overlay').classList.add('active');

        fabric.Image.fromURL(imageUrl, function (img) {
            // Scale image to fit within the canvas (max 40% of canvas size)
            const maxWidth = canvas.width * 0.4;
            const maxHeight = canvas.height * 0.4;

            if (img.width > maxWidth || img.height > maxHeight) {
                const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);
                img.scale(scaleFactor);
            }

            // Center the image
            img.set({
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center'
            });

            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.renderAll();

            // Reset the upload input and preview
            imageUpload.value = '';
            uploadPreview.classList.add('d-none');

            // Hide loading indicator
            document.querySelector('.loading-overlay').classList.remove('active');
        });
    });

    // Product variant selection
    const variantOptions = document.querySelectorAll('.variant-option');
    variantOptions.forEach(option => {
        option.addEventListener('click', function () {
            const variantId = this.getAttribute('data-variant-id');

            // Update hidden input
            document.getElementById('variant-id').value = variantId;

            // Update visual selection
            variantOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');

            // TODO: Update product image background if needed
            // This would require an AJAX call to get the variant data
        });
    });

    // Canvas background settings
    const canvasBackgroundSelect = document.getElementById('canvas-background');
    const customBgColorContainer = document.getElementById('custom-bg-color-container');
    const customBgColorInput = document.getElementById('custom-bg-color');

    canvasBackgroundSelect.addEventListener('change', function () {
        const value = this.value;

        if (value === 'custom') {
            customBgColorContainer.classList.remove('d-none');
            canvas.setBackgroundColor(customBgColorInput.value, canvas.renderAll.bind(canvas));
        } else {
            customBgColorContainer.classList.add('d-none');

            if (value === 'transparent') {
                canvas.setBackgroundColor('', canvas.renderAll.bind(canvas));
            } else if (value === 'white') {
                canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
            } else if (value === 'product') {
                // TODO: Set background to match product color if available
                canvas.setBackgroundColor('#f0f0f0', canvas.renderAll.bind(canvas));
            }
        }
    });

    customBgColorInput.addEventListener('input', function () {
        canvas.setBackgroundColor(this.value, canvas.renderAll.bind(canvas));
    });

    // Show/hide print area
    const showPrintAreaCheck = document.getElementById('show-print-area');
    if (showPrintAreaCheck) {
        showPrintAreaCheck.addEventListener('change', function () {
            // TODO: Implement print area visualization
        });
    }

    // Zoom controls
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');

    zoomInBtn.addEventListener('click', function () {
        if (zoomLevel < 3) {
            zoomLevel += 0.1;
            canvas.setZoom(zoomLevel);
            canvas.setWidth(canvas.getWidth() * (zoomLevel / (zoomLevel - 0.1)));
            canvas.setHeight(canvas.getHeight() * (zoomLevel / (zoomLevel - 0.1)));
            canvas.renderAll();
        }
    });

    zoomOutBtn.addEventListener('click', function () {
        if (zoomLevel > 0.5) {
            zoomLevel -= 0.1;
            canvas.setZoom(zoomLevel);
            canvas.setWidth(canvas.getWidth() * (zoomLevel / (zoomLevel + 0.1)));
            canvas.setHeight(canvas.getHeight() * (zoomLevel / (zoomLevel + 0.1)));
            canvas.renderAll();
        }
    });

    zoomResetBtn.addEventListener('click', function () {
        zoomLevel = 1;
        canvas.setZoom(1);
        canvas.setWidth({{ product_type.default_width }});
    canvas.setHeight({{ product_type.default_height }});
    canvas.renderAll();
        });

    // Object manipulation
    const deleteBtn = document.getElementById('delete-btn');
    deleteBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.remove(activeObject);
            canvas.renderAll();
        }
    });

    const duplicateBtn = document.getElementById('duplicate-btn');
    duplicateBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            // Clone the object
            activeObject.clone(function (cloned) {
                // Offset the position slightly
                cloned.set({
                    left: cloned.left + 10,
                    top: cloned.top + 10,
                    evented: true,
                });

                canvas.add(cloned);
                canvas.setActiveObject(cloned);
                canvas.renderAll();
            });
        }
    });

    const bringForwardBtn = document.getElementById('bring-forward-btn');
    bringForwardBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.bringForward(activeObject);
            canvas.renderAll();
        }
    });

    const sendBackwardBtn = document.getElementById('send-backward-btn');
    sendBackwardBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.sendBackwards(activeObject);
            canvas.renderAll();
        }
    });

    // Save design dialog
    const saveDesignBtn = document.getElementById('save-design-btn');
    const saveDialog = document.querySelector('.save-dialog');
    const dialogOverlay = document.querySelector('.dialog-overlay');
    const cancelSaveBtn = document.getElementById('cancel-save-btn');
    const confirmSaveBtn = document.getElementById('confirm-save-btn');
    const designNameInput = document.getElementById('design-name');

    saveDesignBtn.addEventListener('click', function () {
        saveDialog.classList.add('active');
        dialogOverlay.classList.add('active');
    });

    cancelSaveBtn.addEventListener('click', function () {
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');
    });

    dialogOverlay.addEventListener('click', function () {
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');
    });

    confirmSaveBtn.addEventListener('click', function () {
        const designName = designNameInput.value.trim() || 'Untitled Design';

        // Show loading indicator
        document.querySelector('.loading-overlay').classList.add('active');
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');

        // Generate a preview image
        const dataURL = canvas.toDataURL({
            format: 'png',
            quality: 0.8
        });

        // Prepare the data to save
        const saveData = {
            name: designName,
            canvas_json: JSON.stringify(canvas.toJSON()),
            preview_image: dataURL,
            product_type_id: document.getElementById('product-type-id').value,
            is_draft: true
        };

        // Add variant_id if available
        const variantIdElement = document.getElementById('variant-id');
        if (variantIdElement && variantIdElement.value) {
            saveData.variant_id = variantIdElement.value;
        }

        // Add template_id if available
        const templateIdElement = document.getElementById('template-id');
        if (templateIdElement && templateIdElement.value) {
            saveData.template_id = templateIdElement.value;
        }

        // Add design_id if editing existing design
        const designIdElement = document.getElementById('design-id');
        if (designIdElement && designIdElement.value) {
            saveData.design_id = designIdElement.value;
        }

        // Get CSRF token
        const csrfToken = getCsrfToken();

        // Send the data to the server
        fetch('{% url "designs:save_design" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(saveData)
        })
            .then(response => response.json())
            .then(data => {
                document.querySelector('.loading-overlay').classList.remove('active');

                if (data.success) {
                    // Update design_id if it's a new design
                    if (!designIdElement || !designIdElement.value) {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = 'design-id';
                        hiddenInput.value = data.design_id;
                        document.body.appendChild(hiddenInput);
                    }

                    alert('Design saved successfully!');
                } else {
                    alert('Error saving design: ' + data.error);
                }
            })
            .catch(error => {
                document.querySelector('.loading-overlay').classList.remove('active');
                console.error('Error:', error);
                alert('Error saving design. Please try again.');
            });
    });

    // Helper function to get CSRF token
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];

        return cookieValue || '';
    }

    // Selection events
    canvas.on('selection:created', updateControlsFromSelection);
    canvas.on('selection:updated', updateControlsFromSelection);
    canvas.on('selection:cleared', function () {
        // Reset controls or disable them
        fontFamilySelect.disabled = true;
        fontSizeRange.disabled = true;
        fontSizeValue.disabled = true;
        textColorInput.disabled = true;

        // Reset buttons
        boldBtn.classList.remove('active');
        italicBtn.classList.remove('active');
        underlineBtn.classList.remove('active');

        alignLeftBtn.classList.remove('active');
        alignCenterBtn.classList.remove('active');
        alignRightBtn.classList.remove('active');
    });

    function updateControlsFromSelection(e) {
        const activeObject = e.selected[0];

        if (activeObject && activeObject.type === 'i-text') {
            updateTextControls(activeObject);
        } else {
            // Not a text object, disable text controls
            fontFamilySelect.disabled = true;
            fontSizeRange.disabled = true;
            fontSizeValue.disabled = true;
            textColorInput.disabled = true;

            // Reset button states
            boldBtn.classList.remove('active');
            italicBtn.classList.remove('active');
            underlineBtn.classList.remove('active');

            alignLeftBtn.classList.remove('active');
            alignCenterBtn.classList.remove('active');
            alignRightBtn.classList.remove('active');
        }
    }

    function updateTextControls(textObject) {
        // Enable controls
        fontFamilySelect.disabled = false;
        fontSizeRange.disabled = false;
        fontSizeValue.disabled = false;
        textColorInput.disabled = false;

        // Update values
        fontFamilySelect.value = textObject.fontFamily;
        fontSizeRange.value = textObject.fontSize;
        fontSizeValue.value = textObject.fontSize;
        textColorInput.value = textObject.fill;

        // Update button states
        boldBtn.classList.toggle('active', textObject.fontWeight === 'bold');
        italicBtn.classList.toggle('active', textObject.fontStyle === 'italic');
        underlineBtn.classList.toggle('active', textObject.underline === true);

        // Update alignment
        updateAlignmentButtons(textObject.textAlign);
    }

    function updateTextProperty(property, value) {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            activeObject.set(property, value);
            canvas.renderAll();
        }
    }

    // Load initial canvas state if available
    const initialCanvasJSON = document.getElementById('initial-canvas-json');
    if (initialCanvasJSON && initialCanvasJSON.value) {
        try {
            canvas.loadFromJSON(initialCanvasJSON.value, function () {
                canvas.renderAll();

                // Select first object if available
                if (canvas.getObjects().length > 0) {
                    canvas.setActiveObject(canvas.getObjects()[0]);
                    canvas.renderAll();
                }
            });
        } catch (error) {
            console.error('Error loading initial canvas:', error);
        }
    }

    // Initialize with product image if available
    const productImage = document.getElementById('product-image');
    if (productImage) {
        // You could adjust canvas size or position based on the product image
        // For example, center the canvas over the product image print area
    }
    });
</script>
{% endblock %}