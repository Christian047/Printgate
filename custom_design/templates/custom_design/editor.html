{% extends 'base1.html' %}
{% load static %}
{% load design_filters %}
{% block title %}Design Editor - {{ product_type.name }}{% endblock %}

{% block extra_css %}

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.2.0/css/all.min.css">
<style>
    :root {
        --sidebar-width: 260px;
        --header-height: 60px;
        --footer-height: 50px;
        --mobile-controls-height: 100px;
        --mobile-breakpoint: 768px;
        --mobile-sidebar-width: 60px;
        --mobile-sidebar-expanded-width: 200px;
    }

    .design-editor {
        display: flex;
        flex-direction: column;
        height: calc(100vh - var(--header-height));
        overflow: hidden;

        transform: translateZ(0);
        -webkit-transform: translateZ(0);
    }

    .editor-container {
        display: flex;
        flex: 1;
        overflow: hidden;
        position: relative;
    }





    .design-sidebar {
        width: var(--sidebar-width);
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        display: flex;
        flex-direction: column;
        overflow: hidden;
        z-index: 10;
        transition: transform 0.3s ease, width 0.3s ease;
    }

    .sidebar-nav {
        background-color: #f0f0f0;
        border-bottom: 1px solid #dee2e6;
    }

    .sidebar-content {
        flex: 1;
        overflow-y: auto;
        padding: 15px;
    }

    .design-tabs {
        display: flex;
        list-style: none;
        padding: 0;
        margin: 0;
    }

    .design-tabs li {
        flex: 1;
        text-align: center;
    }

    .design-tabs a {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        padding: 12px 8px;
        color: #495057;
        text-decoration: none;
        border-bottom: 2px solid transparent;
        font-size: 14px;
        transition: all 0.2s;
    }

    .design-tabs a i {
        font-size: 18px;
        margin-bottom: 5px;
        margin-right: 0;
        /* Override previous margin */
    }

    .design-tabs a.active {
        background-color: #fff;
        border-bottom-color: #0d6efd;
        color: #0d6efd;
    }

    .design-tabs a:hover:not(.active) {
        background-color: rgba(0, 0, 0, 0.05);
    }

    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        overflow: auto;
        position: relative;


           /* Optimize scrolling performance */
        -webkit-overflow-scrolling: touch;
        scroll-behavior: smooth;
        /* Enable hardware acceleration */
        transform: translateZ(0);
        will-change: scroll-position;
    }

    #design-canvas {
        background-color: #fff;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .canvas-wrapper {
        position: relative;
    }

    /* Replace your existing .canvas-container styles with this */
    .canvas-container {
        flex: 1;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: #e9ecef;
        position: relative;

        /* These are the important properties for scrolling */
        overflow: auto;
        /* Force horizontal scrollbar */
    }

    /* And make sure this comes after the canvas-container definition */
    .canvas-wrapper {

        padding: 10px;
    }

    .editor-header {
        display: flex;
        align-items: center;
        height: var(--header-height);
        padding: 0 15px;
        background-color: #fff;
        border-bottom: 1px solid #dee2e6;
    }

    .editor-footer {
        display: flex;
        align-items: center;
        justify-content: space-between;
        height: var(--footer-height);
        padding: 0 15px;
        background-color: #fff;
        border-top: 1px solid #dee2e6;
    }

    .control-section {
        margin-bottom: 24px;
    }

    .control-section h3 {
        font-size: 16px;
        margin-bottom: 10px;
        padding-bottom: 6px;
        border-bottom: 1px solid #dee2e6;
        display: flex;
        align-items: center;
    }

    .control-section h3 i {
        margin-right: 8px;
    }

    .control-row {
        display: flex;
        margin-bottom: 8px;
        gap: 8px;
    }

    .control-item {
        flex: 1;
    }

    .btn-group {
        display: flex;
        gap: 4px;
    }

    .color-swatch {
        width: 30px;
        height: 30px;
        border-radius: 4px;
        border: 1px solid #dee2e6;
        cursor: pointer;
        transition: transform 0.2s;
    }

    .color-swatch:hover {
        transform: scale(1.1);
    }

    .variant-options {
        display: flex;
        gap: 8px;
        margin-bottom: 10px;
    }

    .variant-option {
        border: 2px solid #dee2e6;
        border-radius: 4px;
        width: 40px;
        height: 40px;
        cursor: pointer;
        overflow: hidden;
    }

    .variant-option.active {
        border-color: #0d6efd;
    }

    .variant-option img {
        width: 100%;
        height: 100%;
        object-fit: cover;
    }

    /* Moving history and edit controls to fixed floating bar */
    .canvas-controls {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        display: flex;
        gap: 10px;
        background-color: rgba(255, 255, 255, 0.9);
        padding: 10px;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        z-index: 100;
    }

    .canvas-controls-group {
        display: flex;
        gap: 5px;
        border-right: 1px solid #dee2e6;
        padding-right: 10px;
        margin-right: 5px;
    }

    /* Add these styles for the pan controls */
    .pan-controls {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 2px;
    }

    .pan-btn {
        width: 36px;
        height: 36px;
    }

    /* Make the center button visually distinct */
    #pan-center-btn {
        background-color: #f8f9fa;
    }

    .canvas-controls-group:last-child {
        border-right: none;
        padding-right: 0;
        margin-right: 0;
    }

    /* Target specific button for consistency */
    .btn-icon {
        width: 40px;
        height: 40px;
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 0;
    }

    /* Hide content until it's active */
    .tab-content:not(.active) {
        display: none;
    }

    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(255, 255, 255, 0.7);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        visibility: hidden;
        opacity: 0;
        transition: opacity 0.3s, visibility 0.3s;
    }

    .loading-overlay.active {
        visibility: visible;
        opacity: 1;
    }

    /* Save Design Dialog */
    .save-dialog {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
        padding: 20px;
        width: 400px;
        max-width: 90vw;
        display: none;
    }

    .save-dialog.active {
        display: block;
    }

    .dialog-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0, 0, 0, 0.5);
        z-index: 999;
        display: none;
    }

    .dialog-overlay.active {
        display: block;
    }




    /* Editor overlay for templates that require purchase */
    .purchase-editor-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.9);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
        backdrop-filter: blur(5px);
    }

    .purchase-editor-content {
        max-width: 500px;
        padding: 2rem;
        background-color: #fff;
        border: 2px solid #ffd700;
        border-radius: 10px;
        box-shadow: 0 0 30px rgba(255, 215, 0, 0.3);
        text-align: center;
    }

    .purchase-icon {
        font-size: 3rem;
        margin-bottom: 1rem;
        color: #ffd700;
    }

    .purchase-title {
        color: #000;
        font-weight: bold;
        margin-bottom: 1rem;
    }

    .purchase-description {
        color: #555;
        margin-bottom: 1.5rem;
    }

    .template-preview-image {
        max-width: 100%;
        border-radius: 8px;
        border: 1px solid #ddd;
        margin-bottom: 1.5rem;
    }

    .purchase-price {
        font-size: 2.5rem;
        font-weight: bold;
        color: #000;
        margin-bottom: 1rem;
    }

    .purchase-price .currency {
        color: #b8860b;
        font-size: 1.5rem;
    }

    .btn-purchase-now {
        background: #000;
        border: 2px solid #ffd700;
        padding: 10px 20px;
        font-weight: bold;
        color: #ffd700;
        transition: all 0.3s;
    }

    .btn-purchase-now:hover {
        background: #ffd700;
        color: #000;
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
    }

    /* Payment methods */
    .payment-methods {
        display: flex;
        justify-content: center;
        margin-bottom: 1.5rem;
        gap: 10px;
    }

    .payment-method {
        border: 1px solid #dee2e6;
        border-radius: 4px;
        padding: 10px 15px;
        cursor: pointer;
        transition: all 0.2s;
    }

    .payment-method:hover,
    .payment-method.active {
        border-color: #ffd700;
        background-color: rgba(255, 215, 0, 0.1);
    }

    .payment-method img {
        height: 30px;
        width: auto;
    }


/* Add these to your existing styles */

/* Visual feedback when hovering shape cards */
.shape-card {
    position: relative;
    overflow: hidden;
    cursor: pointer;
}

.shape-card::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background-color: rgba(13, 110, 253, 0);
    transition: background-color 0.2s;
    z-index: 1;
    pointer-events: none;
}

.shape-card:hover::after {
    background-color: rgba(13, 110, 253, 0.08);
}

.shape-card:active::after {
    background-color: rgba(13, 110, 253, 0.15);
}

.shape-icon, .shape-name {
    position: relative;
    z-index: 2;
}

/* Delete button */
#delete-shape-btn {
    height: 42px;
    font-weight: 500;
}

/* Empty state message when no shape is selected */
.empty-state {
    text-align: center;
    padding: 20px;
    color: #6c757d;
    font-size: 14px;
}

.empty-state i {
    font-size: 40px;
    margin-bottom: 10px;
    opacity: 0.5;
}

/* Smoothly reveal properties */
#shape-properties {
    transition: opacity 0.3s;
}




    /* Mobile optimization */
 /* Mobile optimization - updated responsive CSS */
@media (max-width: 768px) {
    /* Root variables with rem for better responsiveness */
    :root {
        --mobile-sidebar-width: 260px; /* Use full sidebar width */
        --header-height: 3.75rem;
        --footer-height: 3.125rem;
        --mobile-controls-height: 6.25rem;
        --mobile-breakpoint: 768px;
    }
    
    /* Sidebar positioning and visibility */
    .design-sidebar {
        width: var(--mobile-sidebar-width);
        position: fixed; /* Fixed position instead of absolute */
        height: 100%;
        z-index: 100;
        background-color: #f8f9fa;
        border-right: 1px solid #dee2e6;
        transform: translateX(0); /* Start visible */
 
        display: flex;
        flex-direction: column;
        overflow-y: auto; /* Allow scrolling within sidebar */

        transition: transform 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        /* Better backdrop on mobile */
        box-shadow: 2px 0 20px rgba(0, 0, 0, 0.3);
    }
    
    /* Simple collapsed state - just move off-screen */
    .design-sidebar.collapsed {
        transform: translateX(-100%);
    }
    



/* Add backdrop when sidebar is open */
.sidebar-backdrop {
    position: fixed;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 50;
    opacity: 0;
    visibility: hidden;
    transition: opacity 0.2s, visibility 0.2s;
}

.sidebar-backdrop.active {
    opacity: 1;
    visibility: visible;
}
}







    /* Ensure sidebar content is visible when sidebar is open */
    .design-sidebar:not(.collapsed) .sidebar-content,
    .design-sidebar:not(.collapsed) .sidebar-nav {
        opacity: 1;
        visibility: visible;
        display: block;
    }
    
    /* Remove expanded state completely */
    .design-sidebar.expanded {
        width: var(--mobile-sidebar-width); /* Same width as normal */
    }
    
    /* Make sure tabs are visible */
    .design-tabs {
        display: flex;
        width: 100%;
    }
    
    .design-tabs li {
        flex: 1;
    }
    
    /* Ensure tab text is always visible */
    .design-tabs a span {
        display: inline !important;
    }
    
    /* Toggle button positioning */
    .btn-toggle-sidebar {
        position: fixed;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1000;
        width: 2rem;
        height: 4rem;
        border-radius: 0 1.5625rem 1.5625rem 0;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-left: none;
        box-shadow: 2px 0 8px rgba(0, 0, 0, 0.15);
        padding: 0;
        display: flex !important;
        align-items: center;
        justify-content: center;
        left: 0; /* Start at left edge */
        transition: left 0.3s ease;
    }
    
    /* Move toggle button when sidebar is visible */
    .design-sidebar:not(.collapsed) ~ .btn-toggle-sidebar {
        left: var(--mobile-sidebar-width);
    }
    
    /* Canvas container should use full width when sidebar is collapsed */
    .canvas-container {
        margin-left: 0;
        width: 100%;
        transition: margin-left 0.3s ease, width 0.3s ease;
    }
    
    /* When sidebar is visible, adjust canvas */
    .design-sidebar:not(.collapsed) ~ .canvas-container {
        margin-left: var(--mobile-sidebar-width);
        width: calc(100% - var(--mobile-sidebar-width));
    }
    
    /* Canvas controls for mobile */
    .canvas-controls {
        position: fixed;
        bottom: 1rem;
        right: 1rem;
        left: auto;
        transform: none;
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
        background-color: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(5px);
        padding: 0.5rem;
        border-radius: 0.5rem;
        box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.3);
        max-width: 3.125rem;
        max-height: 80vh;
        overflow-y: auto;
        z-index: 100;
    }
    
    /* Vertical layout for canvas control groups */
    .canvas-controls-group {
        display: flex;
        flex-direction: column;
        gap: 0.25rem;
        border-right: none;
        border-bottom: 1px solid #dee2e6;
        padding-right: 0;
        padding-bottom: 0.5rem;
        margin-right: 0;
        margin-bottom: 0.25rem;
    }
    
    /* Canvas controls toggle button */
    .canvas-controls-toggle {
        position: fixed;
        right: 0.625rem;
        bottom: 0.625rem;
        width: 3.125rem;
        height: 3.125rem;
        background-color: white;
        border-radius: 50%;
        box-shadow: 0 0.125rem 0.3125rem rgba(0, 0, 0, 0.2);
        z-index: 102;
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    /* Pan controls visibility */
    .pan-controls {
        display: none;
    }
    
    .pan-controls.active {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        grid-template-rows: repeat(3, 1fr);
        gap: 0.125rem;
    }
    
    /* Larger, more touch-friendly buttons */
    .btn-icon {
        min-width: 2.8rem;
        min-height: 2.8rem;
        font-size: 1.2rem;
    }
    
    /* Enhanced tooltip */
    .mobile-tooltip {
        position: fixed;
        bottom: 6rem; /* Higher position to avoid conflicts */
        left: 50%;
        transform: translateX(-50%);
        background-color: rgba(0, 0, 0, 0.9);
        color: white;
        padding: 0.75rem 1.25rem;
        border-radius: 0.5rem;
        font-size: 0.875rem;
        z-index: 2000; /* Higher z-index */
        pointer-events: none;
        
        /* Improved visibility handling */
        opacity: 0;
        visibility: hidden;
        transform: translateX(-50%) translateY(10px);
        transition: all 0.3s ease;
        
        /* Ensure it's always on top */
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
        max-width: 85vw;
        text-align: center;
        word-wrap: break-word;
        
        /* Add a small arrow */
        position: relative;
    }



    .mobile-tooltip::after {
        content: '';
        position: absolute;
        top: 100%;
        left: 50%;
        transform: translateX(-50%);
        border: 6px solid transparent;
        border-top-color: rgba(0, 0, 0, 0.9);
    }


    .mobile-tooltip.visible {
        opacity: 1;
    }
    
    /* Hide badge on mobile */
    .badge {
        display: none;
    }
    
    /* Make sure active tab content is visible */
    .tab-content.active {
        display: block !important;
    }
    
    /* Form controls sizing */
    .sidebar-content .form-control,
    .sidebar-content .form-select,
    .sidebar-content .btn {
        font-size: 0.9rem;
        padding: 0.3rem 0.5rem;
    }
}


</style>
{% endblock %}







{% block content %}






<!-- Hidden fields for pay-per-design checks -->
<input type="hidden" id="template-requires-purchase"
    value="{% if template.is_premium and not user|has_purchased:template.id %}true{% else %}false{% endif %}">
<input type="hidden" id="template-id" value="{% if template %}{{ template.id }}{% endif %}">
<input type="hidden" id="template-name" value="{% if template %}{{ template.name }}{% endif %}">

{% if template and template.preview_image and template.preview_image.name %}
    <input type="hidden" id="template-image" value="{{ template.preview_image.url }}">
{% else %}
    <input type="hidden" id="template-image" value="">
{% endif %}











<div class="design-editor">
    <!-- Editor Header -->
    <div class="editor-header">
        <div class="d-flex align-items-center flex-grow-1">
            {% comment %} <a href="{% url 'designs:home' %}" class="btn btn-outline-secondary me-3"> {% endcomment %}
                <i class="fas fa-arrow-left"></i>
            </a>
            <h1 class="h5 mb-0">{{ product_type.name }} Designer</h1>

            {% if template %}
            <span class="badge bg-secondary ms-2">Template: {{ template.name }}</span>
            {% endif %}
        </div>

        <div>
            <button id="save-design-btn" class="btn btn-primary">
                <i class="fas fa-save me-1"></i> Save Design
            </button>
        </div>
    </div>

    <!-- Main Editor Area -->
    <div class="editor-container">
        <!-- Toggle sidebar button for mobile -->
        <button class="btn btn-toggle-sidebar" id="toggle-sidebar">
            <i class="fas fa-chevron-left"></i>
        </button>

        <!-- Sidebar -->
        <div class="design-sidebar" id="design-sidebar">
            <div class="sidebar-nav">
                <ul class="design-tabs">
                    <li>
                        <a href="#" class="active" data-target="tab-text">
                            <i class="fas fa-font"></i>
                            <span>Text</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-upload">
                            <i class="fas fa-upload"></i>
                            <span>Images</span>
                        </a>
                    </li>
                    <li>
                        <a href="#" data-target="tab-product">
                            <i class="fas fa-tshirt"></i>
                            <span>Product</span>
                        </a>
                    </li>

                    <!-- Add this as a new tab in the sidebar-nav section -->
                    <li>
                        <a href="#" data-target="tab-shapes">
                            <i class="fas fa-shapes"></i>
                            <span>Shapes</span>
                        </a>
                    </li>
                </ul>
            </div>

            <div class="sidebar-content">
                <!-- Text Tab -->
                <div class="tab-content active" id="tab-text">
                    <div class="control-section">
                        <h3><i class="fas fa-plus-circle"></i> Add Text</h3>
                        <div class="form-group mb-3">
                            <textarea id="text-input" class="form-control" rows="2"
                                placeholder="Enter your text here..."></textarea>
                        </div>
                        <button id="add-text-btn" class="btn btn-primary w-100">
                            <i class="fas fa-plus me-1"></i> Add Text
                        </button>
                    </div>

                    <div class="control-section">
                        <h3><i class="fas fa-sliders-h"></i> Text Properties</h3>
                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-family" class="form-label">
                                    <i class="fas fa-font"></i> Font
                                </label>
                                <select id="font-family" class="form-select">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Courier New">Courier New</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    {% for font in fonts %}
                                    <option value="{{ font.name }}">{{ font.display_name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                        </div>

                        <div class="control-row">
                            <div class="control-item">
                                <label for="font-size" class="form-label">
                                    <i class="fas fa-text-height"></i> Size
                                </label>
                                <input type="range" class="form-range" id="font-size" min="8" max="120" value="30">
                            </div>
                            <div class="control-item text-center">
                                <label class="form-label"><i class="fas fa-text-height"></i></label>
                                <div class="input-group">
                                    <input type="number" class="form-control" id="font-size-value" min="8" max="120"
                                        value="30">
                                    <span class="input-group-text">px</span>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-palette"></i> Color
                                </label>
                                <input type="color" class="form-control form-control-color w-100" id="text-color"
                                    value="#000000">
                            </div>
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-tint"></i> Presets
                                </label>
                                <div class="d-flex flex-wrap gap-1">
                                    <div class="color-swatch" style="background-color: #000000" data-color="#000000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ffffff" data-color="#ffffff">
                                    </div>
                                    <div class="color-swatch" style="background-color: #ff0000" data-color="#ff0000">
                                    </div>
                                    <div class="color-swatch" style="background-color: #0000ff" data-color="#0000ff">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="control-row mt-3">
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-font"></i> Style
                                </label>
                                <div class="btn-group w-100">
                                    <button id="bold-btn" class="btn btn-outline-secondary btn-icon" title="Bold">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button id="italic-btn" class="btn btn-outline-secondary btn-icon" title="Italic">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button id="underline-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Underline">
                                        <i class="fas fa-underline"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="control-item">
                                <label class="form-label">
                                    <i class="fas fa-align-left"></i> Align
                                </label>
                                <div class="btn-group w-100">
                                    <button id="align-left-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Left">
                                        <i class="fas fa-align-left"></i>
                                    </button>
                                    <button id="align-center-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Center">
                                        <i class="fas fa-align-center"></i>
                                    </button>
                                    <button id="align-right-btn" class="btn btn-outline-secondary btn-icon"
                                        title="Align Right">
                                        <i class="fas fa-align-right"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Upload Tab -->
                <div class="tab-content" id="tab-upload">
                    <div class="control-section">
                        <h3><i class="fas fa-cloud-upload-alt"></i> Upload Image</h3>
                        <p class="text-muted small">Supported: PNG, JPG, SVG (max 5MB)</p>

                        <div class="mb-3">
                            <input type="file" id="image-upload" class="form-control" accept="image/*">
                        </div>

                        <div id="upload-preview" class="text-center mt-3 d-none">
                            <img id="upload-preview-img" src="" alt="Preview" class="img-fluid border rounded">
                            <button id="add-upload-btn" class="btn btn-primary mt-2 w-100">
                                <i class="fas fa-plus me-1"></i> Add to Design
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Product Tab -->
                <div class="tab-content" id="tab-product">
                    <div class="control-section">
                        <h3><i class="fas fa-tshirt"></i> Product Options</h3>

                        {% if all_variants %}
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-palette"></i> Color/Variant
                            </label>
                            <div class="variant-options">
                                {% for v in all_variants %}
                                <div class="variant-option {% if variant.id == v.id %}active{% endif %}"
                                    data-variant-id="{{ v.id }}">
                                    {% if v.color_hex %}
                                    <div style="background-color: {{ v.color_hex }}; width: 100%; height: 100%;"></div>
                                    {% else %}
                                    <img src="{{ v.base_image.url }}" alt="{{ v.name }}">
                                    {% endif %}
                                </div>
                                {% endfor %}
                            </div>
                        </div>
                        {% endif %}

                        {% if product_type.has_print_area %}
                        <div class="form-check mb-3">
                            <input class="form-check-input" type="checkbox" id="show-print-area" checked>
                            <label class="form-check-label" for="show-print-area">
                                <i class="fas fa-border-style"></i> Show Print Area
                            </label>
                        </div>
                        {% endif %}

                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-fill-drip"></i> Canvas Background
                            </label>
                            <select id="canvas-background" class="form-select">
                                <option value="transparent">Transparent</option>
                                <option value="white" selected>White</option>
                                <option value="product">Product Color</option>
                                <option value="custom">Custom Color</option>
                            </select>
                        </div>

                        <div id="custom-bg-color-container" class="mb-3 d-none">
                            <label class="form-label">
                                <i class="fas fa-palette"></i> Custom Background
                            </label>
                            <input type="color" id="custom-bg-color" class="form-control form-control-color w-100"
                                value="#ffffff">
                        </div>
                    </div>
                </div>


<!-- Updated Shapes Tab with Improved UX -->
<!-- Shapes Tab -->
<div class="tab-content" id="tab-shapes">
    <!-- Shape Type Selection -->
    <div class="control-section">
        <h3><i class="fas fa-shapes"></i> Add Shape</h3>
        <div class="shape-selector mb-3">
            <div class="row g-2">
                <div class="col-6">
                    <div id="add-rect-btn" class="shape-card">
                        <div class="shape-icon"><i class="fas fa-square"></i></div>
                        <div class="shape-name">Rectangle</div>
                    </div>
                </div>
                <div class="col-6">
                    <div id="add-circle-btn" class="shape-card">
                        <div class="shape-icon"><i class="fas fa-circle"></i></div>
                        <div class="shape-name">Circle</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Shape Properties - ALWAYS VISIBLE -->
    <div class="control-section">
        <h3><i class="fas fa-palette"></i> Shape Appearance</h3>
        <!-- Fill color with presets -->
        <div class="control-row">
            <div class="control-item">
                <label class="form-label">Fill Color</label>
                <input type="color" id="shape-fill-color" class="form-control form-control-color w-100" value="#3498db">
            </div>
            <div class="control-item">
                <label class="form-label">Presets</label>
                <div class="d-flex flex-wrap gap-1">
                    <div class="color-swatch" style="background-color: #3498db" data-color="#3498db"></div>
                    <div class="color-swatch" style="background-color: #e74c3c" data-color="#e74c3c"></div>
                    <div class="color-swatch" style="background-color: #2ecc71" data-color="#2ecc71"></div>
                    <div class="color-swatch" style="background-color: #f1c40f" data-color="#f1c40f"></div>
                </div>
            </div>
        </div>

        <!-- Stroke color and width -->
        <div class="control-row mt-3">
            <div class="control-item">
                <label class="form-label">Stroke Color</label>
                <input type="color" id="shape-stroke-color" class="form-control form-control-color w-100"
                    value="#2980b9">
            </div>
            <div class="control-item">
                <label for="shape-stroke-width" class="form-label">Width</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="shape-stroke-width-value" min="0" max="20" value="2">
                    <span class="input-group-text">px</span>
                </div>
            </div>
        </div>

        <!-- Opacity slider -->
        <div class="control-row mt-3">
            <div class="control-item">
                <label for="shape-opacity" class="form-label">Opacity</label>
                <input type="range" class="form-range" id="shape-opacity" min="0" max="1" step="0.05" value="1">
            </div>
            <div class="control-item text-center">
                <label class="form-label">Value</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="shape-opacity-value" min="0" max="100" value="100">
                    <span class="input-group-text">%</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Rectangle Properties -->
    <div id="rectangle-controls" class="control-section">
        <h3><i class="fas fa-square"></i> Rectangle Properties</h3>
        <div class="control-row">
            <div class="control-item">
                <label for="rect-width" class="form-label">Width</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="rect-width" min="10" max="500" value="150">
                    <span class="input-group-text">px</span>
                </div>
            </div>
            <div class="control-item">
                <label for="rect-height" class="form-label">Height</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="rect-height" min="10" max="500" value="100">
                    <span class="input-group-text">px</span>
                </div>
            </div>
        </div>

        <div class="control-row mt-3">
            <div class="control-item">
                <label for="rect-radius" class="form-label">Corner Radius</label>
                <input type="range" class="form-range" id="rect-radius" min="0" max="100" value="0">
            </div>
            <div class="control-item text-center">
                <label class="form-label">Value</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="rect-radius-value" min="0" max="100" value="0">
                    <span class="input-group-text">px</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Circle Properties -->
    <div id="circle-controls" class="control-section" style="display: none;">
        <h3><i class="fas fa-circle"></i> Circle Properties</h3>
        <div class="control-row">
            <div class="control-item">
                <label for="circle-radius" class="form-label">Radius</label>
                <input type="range" class="form-range" id="circle-radius" min="10" max="200" value="50">
            </div>
            <div class="control-item text-center">
                <label class="form-label">Value</label>
                <div class="input-group">
                    <input type="number" class="form-control" id="circle-radius-value" min="10" max="200" value="50">
                    <span class="input-group-text">px</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Delete button -->
    <button id="delete-shape-btn" class="btn btn-outline-danger w-100 mt-3">
        <i class="fas fa-trash me-2"></i> Delete Shape
    </button>
</div>



            </div>
        </div>

        <!-- Canvas Area -->
        <div class="canvas-container">
            <div class="canvas-wrapper">
                <div id="product-background">
                    {% if variant %}
                    <img src="{{ variant.base_image.url }}" alt="{{ variant.name }}" id="product-image"
                        style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: -1;">
                    {% endif %}
                </div>
                <canvas id="design-canvas"></canvas>
            </div>
        </div>

        <!-- Floating Canvas Controls -->
        <div class="canvas-controls">
            <!-- Undo/Redo Controls -->
            <div class="canvas-controls-group">
                <button id="undo-btn" class="btn btn-outline-secondary btn-icon disabled" title="Undo (Ctrl+Z)">
                    <i class="fas fa-undo"></i>
                </button>
                <button id="redo-btn" class="btn btn-outline-secondary btn-icon disabled" title="Redo (Ctrl+Y)">
                    <i class="fas fa-redo"></i>
                </button>
            </div>

            <!-- Zoom Controls -->
            <div class="canvas-controls-group">
                <button id="zoom-in-btn" class="btn btn-outline-secondary btn-icon" title="Zoom In">
                    <i class="fas fa-search-plus"></i>
                </button>
                <button id="zoom-out-btn" class="btn btn-outline-secondary btn-icon" title="Zoom Out">
                    <i class="fas fa-search-minus"></i>
                </button>
                <button id="zoom-reset-btn" class="btn btn-outline-secondary btn-icon" title="Reset Zoom">
                    <i class="fas fa-expand"></i>
                </button>
            </div>

            <!-- Object Controls -->
            <div class="canvas-controls-group">
                <button id="delete-btn" class="btn btn-outline-danger btn-icon" title="Delete Selected Object">
                    <i class="fas fa-trash"></i>
                </button>
                <button id="duplicate-btn" class="btn btn-outline-secondary btn-icon" title="Duplicate Selected Object">
                    <i class="fas fa-copy"></i>
                </button>
                <button id="bring-forward-btn" class="btn btn-outline-secondary btn-icon" title="Bring Forward">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button id="send-backward-btn" class="btn btn-outline-secondary btn-icon" title="Send Backward">
                    <i class="fas fa-arrow-down"></i>
                </button>
            </div>

            <!-- Add this to your canvas controls section -->
            <div class="canvas-controls-group">
                <div class="pan-controls">
                    <button id="pan-up-left-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Up-Left">
                        <i class="fas fa-arrow-up" style="transform: rotate(-45deg);"></i>
                    </button>
                    <button id="pan-up-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Up">
                        <i class="fas fa-arrow-up"></i>
                    </button>
                    <button id="pan-up-right-btn" class="btn btn-outline-secondary btn-icon pan-btn"
                        title="Pan Up-Right">
                        <i class="fas fa-arrow-up" style="transform: rotate(45deg);"></i>
                    </button>
                    <button id="pan-left-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Left">
                        <i class="fas fa-arrow-left"></i>
                    </button>
                    <button id="pan-center-btn" class="btn btn-outline-secondary btn-icon pan-btn"
                        title="Center Canvas">
                        <i class="fas fa-bullseye"></i>
                    </button>
                    <button id="pan-right-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Right">
                        <i class="fas fa-arrow-right"></i>
                    </button>
                    <button id="pan-down-left-btn" class="btn btn-outline-secondary btn-icon pan-btn"
                        title="Pan Down-Left">
                        <i class="fas fa-arrow-down" style="transform: rotate(45deg);"></i>
                    </button>
                    <button id="pan-down-btn" class="btn btn-outline-secondary btn-icon pan-btn" title="Pan Down">
                        <i class="fas fa-arrow-down"></i>
                    </button>
                    <button id="pan-down-right-btn" class="btn btn-outline-secondary btn-icon pan-btn"
                        title="Pan Down-Right">
                        <i class="fas fa-arrow-down" style="transform: rotate(-45deg);"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div class="loading-overlay">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<!-- Save Design Dialog -->
<div class="dialog-overlay"></div>
<div class="save-dialog">
    <h3 class="h5 mb-3">Save Your Design</h3>
    <div class="mb-3">
        <label for="design-name" class="form-label">Design Name</label>
        <input type="text" id="design-name" class="form-control" placeholder="Enter a name for your design"
            value="{% if user_design %}{{ user_design.name }}{% else %}Untitled Design{% endif %}">
    </div>
    <div class="d-flex justify-content-end gap-2 mt-4">
        <button id="cancel-save-btn" class="btn btn-outline-secondary">Cancel</button>
        <button id="confirm-save-btn" class="btn btn-primary">Save Design</button>
    </div>
</div>
















<!-- Hidden inputs for context data -->
<input type="hidden" id="product-type-id" value="{{ product_type.id }}">
{% if variant %}
<input type="hidden" id="variant-id" value="{{ variant.id }}">
{% endif %}
{% if template %}
<input type="hidden" id="template-id" value="{{ template.id }}">
{% else %}
No Template
{% endif %}
{% if user_design %}
<input type="hidden" id="design-id" value="{{ user_design.id }}">
{% endif %}
<!-- Use textarea for JSON -->
{% if initial_json %}
<textarea id="initial-canvas-json" style="display: none;">{{ initial_json }}</textarea>
{% endif %}



{% endblock %}





{% block footer %}{% endblock %}





{% block extra_js %}
<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.1/fabric.min.js"></script>


<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Initialize the canvas
        const canvas = new fabric.Canvas('design-canvas', {
            width: {{ product_type.default_width }},
        height: {{ product_type.default_height }},
        backgroundColor: 'white',
        preserveObjectStacking: true
        });

    // Store canvas in window for access by other functions
    window.canvas = canvas;

    // Keep track of current zoom level
    let zoomLevel = 1;
    window.zoomLevel = zoomLevel;

    // Variables to track the currently selected object
    let selectedObject = null;

    // History management for undo/redo
    const history = {
        canvasState: [],
        currentStateIndex: -1,
        undoButton: document.getElementById('undo-btn'),
        redoButton: document.getElementById('redo-btn'),

        saveState() {
            // Discard states after the current one when a new action is performed
            if (this.currentStateIndex < this.canvasState.length - 1) {
                this.canvasState = this.canvasState.slice(0, this.currentStateIndex + 1);
            }

            // Save current state
            this.canvasState.push(JSON.stringify(canvas.toJSON()));
            this.currentStateIndex = this.canvasState.length - 1;

            // Update buttons state
            this.updateButtonsState();
        },

        undo() {
            if (this.currentStateIndex > 0) {
                this.currentStateIndex--;
                this.loadState();
            }
        },

        redo() {
            if (this.currentStateIndex < this.canvasState.length - 1) {
                this.currentStateIndex++;
                this.loadState();
            }
        },

        loadState() {
            canvas.loadFromJSON(this.canvasState[this.currentStateIndex], function () {
                canvas.renderAll();
            });

            this.updateButtonsState();
        },

        updateButtonsState() {
            // Enable/disable undo button
            if (this.currentStateIndex > 0) {
                this.undoButton.classList.remove('disabled');
            } else {
                this.undoButton.classList.add('disabled');
            }

            // Enable/disable redo button
            if (this.currentStateIndex < this.canvasState.length - 1) {
                this.redoButton.classList.remove('disabled');
            } else {
                this.redoButton.classList.add('disabled');
            }
        }
    };

    // Initialize history with current state
    history.saveState();

    // Bind undo/redo buttons
    document.getElementById('undo-btn').addEventListener('click', function () {
        history.undo();
    });

    document.getElementById('redo-btn').addEventListener('click', function () {
        history.redo();
    });

    // Create mobile tooltip element
    const mobileTooltip = document.createElement('div');
    mobileTooltip.className = 'mobile-tooltip';
    document.body.appendChild(mobileTooltip);

    // Check if we're on mobile
    const isMobile = window.innerWidth <= 768;

    // Get elements for mobile optimization
    const sidebar = document.getElementById('design-sidebar');
    const toggleSidebarBtn = document.getElementById('toggle-sidebar');
    const canvasContainer = document.querySelector('.canvas-container');
    const tabLinks = document.querySelectorAll('.design-tabs a');

    // Initialize mobile view if needed
    if (isMobile) {
        // Add mobile-specific elements
        setupMobileControls();

        // Update toggle button icon
        if (toggleSidebarBtn) {
            toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
        }

        // Set initial states
        sidebar.classList.add('collapsed');
        document.body.classList.add('mobile-view');
    }

    // Simplified sidebar toggle with only two states: open or closed
    if (toggleSidebarBtn) {
        toggleSidebarBtn.addEventListener('click', function () {
            sidebar.classList.toggle('collapsed');

            // Update button icon based on current state
            if (sidebar.classList.contains('collapsed')) {
                this.innerHTML = '<i class="fas fa-chevron-right"></i>';
                showMobileTooltip('Sidebar hidden');
            } else {
                this.innerHTML = '<i class="fas fa-chevron-left"></i>';
                showMobileTooltip('Sidebar visible');
            }

            // Adjust canvas scaling when sidebar state changes
            adjustCanvasScaling();
        });
    }

    // Handle tab clicks
    tabLinks.forEach(link => {
        link.addEventListener('click', function (e) {
            // Normal tab activation logic
            const targetId = this.getAttribute('data-target');

            // Deactivate all tabs and contents
            tabLinks.forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

            // Activate current tab and content
            this.classList.add('active');
            document.getElementById(targetId).classList.add('active');

            // Mobile-specific behavior
            if (isMobile && sidebar.classList.contains('collapsed')) {
                // When sidebar is collapsed, expand it when a tab is clicked
                sidebar.classList.remove('collapsed');
                if (toggleSidebarBtn) {
                    toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
                }

                // Show tooltip for what tab was opened
                const tabName = this.querySelector('span').textContent;
                showMobileTooltip(`${tabName} panel opened`);
            }
        });
    });

    // Enhanced tooltip function - displays faster and for a shorter duration
    function showMobileTooltip(message) {
        
        mobileTooltip.textContent = message;
        mobileTooltip.classList.add('visible');

        // Hide after 1.5 seconds (faster feedback)
        setTimeout(() => {
            mobileTooltip.classList.remove('visible');
        }, 1500);
    }

    // Make tooltip function available to window
    window.showMobileTooltip = showMobileTooltip;

    // Add text to canvas
    const addTextBtn = document.getElementById('add-text-btn');
    const textInput = document.getElementById('text-input');

    addTextBtn.addEventListener('click', function () {
        if (!textInput.value.trim()) return;

        const text = new fabric.IText(textInput.value.trim(), {
            left: canvas.width / 2,
            top: canvas.height / 2,
            fontFamily: 'Arial',
            fontSize: 30,
            fill: '#000000',
            textAlign: 'center',
            originX: 'center',
            originY: 'center'
        });

        canvas.add(text);
        canvas.setActiveObject(text);
        text.enterEditing();
        canvas.renderAll();

        // Save state for undo/redo
        history.saveState();

        // Clear the input
        textInput.value = '';

        // Update the controls
        updateTextControls(text);

        // Auto-collapse sidebar on very small screens after adding text
        if (isMobile && window.innerWidth < 480) {
            setTimeout(() => {
                sidebar.classList.add('collapsed');
                if (toggleSidebarBtn) {
                    toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                }
                adjustCanvasScaling();
            }, 500);
        }
    });

    // Font family change
    const fontFamilySelect = document.getElementById('font-family');
    fontFamilySelect.addEventListener('change', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            activeObject.set('fontFamily', this.value);
            canvas.renderAll();
            history.saveState();
        }
    });

    // Font size change
    const fontSizeRange = document.getElementById('font-size');
    const fontSizeValue = document.getElementById('font-size-value');

    fontSizeRange.addEventListener('input', function () {
        fontSizeValue.value = this.value;
        updateTextProperty('fontSize', parseInt(this.value));
    });

    fontSizeRange.addEventListener('change', function () {
        // Only save state when slider interaction is complete
        history.saveState();
    });

    fontSizeValue.addEventListener('input', function () {
        fontSizeRange.value = this.value;
        updateTextProperty('fontSize', parseInt(this.value));
    });

    fontSizeValue.addEventListener('change', function () {
        history.saveState();
    });

    // Text color change
    const textColorInput = document.getElementById('text-color');
    textColorInput.addEventListener('input', function () {
        updateTextProperty('fill', this.value);
    });

    textColorInput.addEventListener('change', function () {
        history.saveState();
    });

    // Color swatches
    const colorSwatches = document.querySelectorAll('.color-swatch');
    colorSwatches.forEach(swatch => {
        swatch.addEventListener('click', function () {
            const color = this.getAttribute('data-color');
            textColorInput.value = color;
            updateTextProperty('fill', color);
            history.saveState();
        });
    });

    // Text style buttons
    const boldBtn = document.getElementById('bold-btn');
    boldBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isBold = activeObject.fontWeight === 'bold';
            activeObject.set('fontWeight', isBold ? 'normal' : 'bold');

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
            history.saveState();
        }
    });

    const italicBtn = document.getElementById('italic-btn');
    italicBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isItalic = activeObject.fontStyle === 'italic';
            activeObject.set('fontStyle', isItalic ? 'normal' : 'italic');

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
            history.saveState();
        }
    });

    const underlineBtn = document.getElementById('underline-btn');
    underlineBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            const isUnderlined = activeObject.underline;
            activeObject.set('underline', !isUnderlined);

            // Toggle button active state
            this.classList.toggle('active');

            canvas.renderAll();
            history.saveState();
        }
    });

    // Text alignment buttons
    const alignLeftBtn = document.getElementById('align-left-btn');
    alignLeftBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'left');
        updateAlignmentButtons('left');
        history.saveState();
    });

    const alignCenterBtn = document.getElementById('align-center-btn');
    alignCenterBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'center');
        updateAlignmentButtons('center');
        history.saveState();
    });

    const alignRightBtn = document.getElementById('align-right-btn');
    alignRightBtn.addEventListener('click', function () {
        updateTextProperty('textAlign', 'right');
        updateAlignmentButtons('right');
        history.saveState();
    });

    function updateAlignmentButtons(alignment) {
        alignLeftBtn.classList.remove('active');
        alignCenterBtn.classList.remove('active');
        alignRightBtn.classList.remove('active');

        if (alignment === 'left') alignLeftBtn.classList.add('active');
        if (alignment === 'center') alignCenterBtn.classList.add('active');
        if (alignment === 'right') alignRightBtn.classList.add('active');
    }

    // Upload images
    const imageUpload = document.getElementById('image-upload');
    const uploadPreview = document.getElementById('upload-preview');
    const uploadPreviewImg = document.getElementById('upload-preview-img');
    const addUploadBtn = document.getElementById('add-upload-btn');

    imageUpload.addEventListener('change', function (e) {
        if (this.files && this.files[0]) {
            const file = this.files[0];

            // Validate file size (5MB max)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size exceeds 5MB limit.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                uploadPreviewImg.src = e.target.result;
                uploadPreview.classList.remove('d-none');
            };
            reader.readAsDataURL(file);
        }
    });

    addUploadBtn.addEventListener('click', function () {
        const imageUrl = uploadPreviewImg.src;

        // Show loading indicator
        document.querySelector('.loading-overlay').classList.add('active');

        fabric.Image.fromURL(imageUrl, function (img) {
            // Scale image to fit within the canvas (max 40% of canvas size)
            const maxWidth = canvas.width * 0.4;
            const maxHeight = canvas.height * 0.4;

            if (img.width > maxWidth || img.height > maxHeight) {
                const scaleFactor = Math.min(maxWidth / img.width, maxHeight / img.height);
                img.scale(scaleFactor);
            }

            // Center the image
            img.set({
                left: canvas.width / 2,
                top: canvas.height / 2,
                originX: 'center',
                originY: 'center'
            });

            canvas.add(img);
            canvas.setActiveObject(img);
            canvas.renderAll();
            history.saveState();

            // Reset the upload input and preview
            imageUpload.value = '';
            uploadPreview.classList.add('d-none');

            // Hide loading indicator
            document.querySelector('.loading-overlay').classList.remove('active');

            // Auto-collapse sidebar on small screens after adding image
            if (isMobile && window.innerWidth < 480) {
                setTimeout(() => {
                    sidebar.classList.add('collapsed');
                    if (toggleSidebarBtn) {
                        toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
                    }
                    adjustCanvasScaling();
                }, 500);
            }
        });
    });

    // Product variant selection
    const variantOptions = document.querySelectorAll('.variant-option');
    variantOptions.forEach(option => {
        option.addEventListener('click', function () {
            const variantId = this.getAttribute('data-variant-id');

            // Update hidden input
            document.getElementById('variant-id').value = variantId;

            // Update visual selection
            variantOptions.forEach(opt => opt.classList.remove('active'));
            this.classList.add('active');

            // TODO: Update product image background if needed
            // This would require an AJAX call to get the variant data
        });
    });

    // Canvas background settings
    const canvasBackgroundSelect = document.getElementById('canvas-background');
    const customBgColorContainer = document.getElementById('custom-bg-color-container');
    const customBgColorInput = document.getElementById('custom-bg-color');

    canvasBackgroundSelect.addEventListener('change', function () {
        const value = this.value;

        if (value === 'custom') {
            customBgColorContainer.classList.remove('d-none');
            canvas.setBackgroundColor(customBgColorInput.value, canvas.renderAll.bind(canvas));
        } else {
            customBgColorContainer.classList.add('d-none');

            if (value === 'transparent') {
                canvas.setBackgroundColor('', canvas.renderAll.bind(canvas));
            } else if (value === 'white') {
                canvas.setBackgroundColor('#ffffff', canvas.renderAll.bind(canvas));
            } else if (value === 'product') {
                // TODO: Set background to match product color if available
                canvas.setBackgroundColor('#f0f0f0', canvas.renderAll.bind(canvas));
            }
        }
        history.saveState();
    });

    customBgColorInput.addEventListener('input', function () {
        canvas.setBackgroundColor(this.value, canvas.renderAll.bind(canvas));
    });

    customBgColorInput.addEventListener('change', function () {
        history.saveState();
    });

    // Show/hide print area
    const showPrintAreaCheck = document.getElementById('show-print-area');
    if (showPrintAreaCheck) {
        showPrintAreaCheck.addEventListener('change', function () {
            // TODO: Implement print area visualization
        });
    }

    // Zoom controls
    const zoomInBtn = document.getElementById('zoom-in-btn');
    const zoomOutBtn = document.getElementById('zoom-out-btn');
    const zoomResetBtn = document.getElementById('zoom-reset-btn');

    zoomInBtn.addEventListener('click', function () {
        if (zoomLevel < 3) {
            zoomLevel += 0.1;
            updateZoom();
        }
    });

    zoomOutBtn.addEventListener('click', function () {
            if (zoomLevel > 0.5) {
                zoomLevel -= 0.1;
                updateZoom();
            }
        });

        zoomResetBtn.addEventListener('click', function () {
            zoomLevel = 1;
            updateZoom();
        });

        function updateZoom() {
            canvas.setZoom(zoomLevel);
            canvas.setWidth({{ product_type.default_width }} * zoomLevel);
        canvas.setHeight({{ product_type.default_height }} * zoomLevel);
        canvas.renderAll();
    }

        // Pan controls
        const panStep = 50; // pixels to move per pan action

        document.getElementById('pan-up-btn').addEventListener('click', function () {
            canvas.relativePan(new fabric.Point(0, -panStep)); // Negative Y to move up
            canvas.renderAll();
        });
    
    document.getElementById('pan-down-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(0, panStep)); // Positive Y to move down
        canvas.renderAll();
    });

    document.getElementById('pan-left-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(-panStep, 0)); // Negative X to move left
        canvas.renderAll();
    });

    document.getElementById('pan-right-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(panStep, 0)); // Positive X to move right
        canvas.renderAll();
    });

    document.getElementById('pan-up-left-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(-panStep, -panStep)); // Move up-left
        canvas.renderAll();
    });

    document.getElementById('pan-up-right-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(panStep, -panStep)); // Move up-right
        canvas.renderAll();
    });

    document.getElementById('pan-down-left-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(-panStep, panStep)); // Move down-left
        canvas.renderAll();
    });

    document.getElementById('pan-down-right-btn').addEventListener('click', function () {
        canvas.relativePan(new fabric.Point(panStep, panStep)); // Move down-right
        canvas.renderAll();
    });

    // Center canvas button
    document.getElementById('pan-center-btn').addEventListener('click', function () {
        centerCanvas();
    });

    // Function to center canvas
    function centerCanvas() {
        canvas.setViewportTransform([1, 0, 0, 1, 0, 0]);
        canvas.renderAll();
        showMobileTooltip('Canvas centered');
    }

    // Object manipulation
    const deleteBtn = document.getElementById('delete-btn');
    deleteBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.remove(activeObject);
            canvas.renderAll();
            history.saveState();
        }
    });

    const duplicateBtn = document.getElementById('duplicate-btn');
    duplicateBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            // Clone the object
            activeObject.clone(function (cloned) {
                // Offset the position slightly
                cloned.set({
                    left: cloned.left + 10,
                    top: cloned.top + 10,
                    evented: true,
                });

                canvas.add(cloned);
                canvas.setActiveObject(cloned);
                canvas.renderAll();
                history.saveState();
            });
        }
    });

    const bringForwardBtn = document.getElementById('bring-forward-btn');
    bringForwardBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.bringForward(activeObject);
            canvas.renderAll();
            history.saveState();
        }
    });

    const sendBackwardBtn = document.getElementById('send-backward-btn');
    sendBackwardBtn.addEventListener('click', function () {
        const activeObject = canvas.getActiveObject();
        if (activeObject) {
            canvas.sendBackwards(activeObject);
            canvas.renderAll();
            history.saveState();
        }
    });

    // Save design dialog
    const saveDesignBtn = document.getElementById('save-design-btn');
    const saveDialog = document.querySelector('.save-dialog');
    const dialogOverlay = document.querySelector('.dialog-overlay');
    const cancelSaveBtn = document.getElementById('cancel-save-btn');
    const confirmSaveBtn = document.getElementById('confirm-save-btn');
    const designNameInput = document.getElementById('design-name');

    saveDesignBtn.addEventListener('click', function () {
        saveDialog.classList.add('active');
        dialogOverlay.classList.add('active');
    });

    cancelSaveBtn.addEventListener('click', function () {
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');
    });

    dialogOverlay.addEventListener('click', function () {
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');
    });

    confirmSaveBtn.addEventListener('click', function () {
        const designName = designNameInput.value.trim() || 'Untitled Design';

        // Show loading indicator
        document.querySelector('.loading-overlay').classList.add('active');
        saveDialog.classList.remove('active');
        dialogOverlay.classList.remove('active');

        // Generate a preview image
        const dataURL = canvas.toDataURL({
            format: 'png',
            quality: 0.8
        });

        // Prepare the data to save
        const saveData = {
            name: designName,
            canvas_json: JSON.stringify(canvas.toJSON()),
            preview_image: dataURL,
            product_type_id: document.getElementById('product-type-id').value,
            is_draft: true
        };

        // Add variant_id if available
        const variantIdElement = document.getElementById('variant-id');
        if (variantIdElement && variantIdElement.value) {
            saveData.variant_id = variantIdElement.value;
        }

        // Add template_id if available
        const templateIdElement = document.getElementById('template-id');
        if (templateIdElement && templateIdElement.value) {
            saveData.template_id = templateIdElement.value;
        }

        // Add design_id if editing existing design
        const designIdElement = document.getElementById('design-id');
        if (designIdElement && designIdElement.value) {
            saveData.design_id = designIdElement.value;
        }

        // Get CSRF token
        const csrfToken = getCsrfToken();

        // Send the data to the server
        fetch('{% url "save_design" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(saveData)
        })
            .then(response => response.json())
            .then(data => {
                document.querySelector('.loading-overlay').classList.remove('active');

                if (data.success) {
                    // Update design_id if it's a new design
                    if (!designIdElement || !designIdElement.value) {
                        const hiddenInput = document.createElement('input');
                        hiddenInput.type = 'hidden';
                        hiddenInput.id = 'design-id';
                        hiddenInput.value = data.design_id;
                        document.body.appendChild(hiddenInput);
                    }

                    if (data.redirect_url) {
                        console.log("Redirect URL found:", data.redirect_url);
                        console.log("Redirecting...");
                        window.location.href = data.redirect_url;
                        return;
                    } else {
                        console.log("No redirect URL in response");
                    }

                    alert('Design saved successfully!');
                } else {
                    alert('Error saving design: ' + data.error);
                }
            })
            .catch(error => {
                document.querySelector('.loading-overlay').classList.remove('active');
                console.error('Error:', error);

                // Check if error might be related to authentication or HTML redirect
                if (error.name === 'SyntaxError' &&
                    error.message.includes('Unexpected token') &&
                    error.message.includes('<!doctype')) {

                    console.log("Detected login redirect, navigating to login page...");
                    const currentUrl = encodeURIComponent(window.location.href);
                    window.location.href = '/auth/login/?next=' + currentUrl;
                } else {
                    alert('Error saving design. Please try again.');
                }
            });
    });

    // Helper function to get CSRF token
    function getCsrfToken() {
        const cookieValue = document.cookie
            .split('; ')
            .find(row => row.startsWith('csrftoken='))
            ?.split('=')[1];

        return cookieValue || '';
    }

    // Selection events
    canvas.on('selection:created', updateControlsFromSelection);
    canvas.on('selection:updated', updateControlsFromSelection);
    canvas.on('selection:cleared', function () {
        // Reset controls or disable them
        fontFamilySelect.disabled = true;
        fontSizeRange.disabled = true;
        fontSizeValue.disabled = true;
        textColorInput.disabled = true;

        // Reset buttons
        boldBtn.classList.remove('active');
        italicBtn.classList.remove('active');
        underlineBtn.classList.remove('active');

        alignLeftBtn.classList.remove('active');
        alignCenterBtn.classList.remove('active');
        alignRightBtn.classList.remove('active');
    });

    function updateControlsFromSelection(e) {
        const activeObject = e.selected[0];

        if (activeObject && activeObject.type === 'i-text') {
            updateTextControls(activeObject);
        } else {
            // Not a text object, disable text controls
            fontFamilySelect.disabled = true;
            fontSizeRange.disabled = true;
            fontSizeValue.disabled = true;
            textColorInput.disabled = true;

            // Reset button states
            boldBtn.classList.remove('active');
            italicBtn.classList.remove('active');
            underlineBtn.classList.remove('active');

            alignLeftBtn.classList.remove('active');
            alignCenterBtn.classList.remove('active');
            alignRightBtn.classList.remove('active');
        }
    }

    function updateTextControls(textObject) {
        // Enable controls
        fontFamilySelect.disabled = false;
        fontSizeRange.disabled = false;
        fontSizeValue.disabled = false;
        textColorInput.disabled = false;

        // Update values
        fontFamilySelect.value = textObject.fontFamily;
        fontSizeRange.value = textObject.fontSize;
        fontSizeValue.value = textObject.fontSize;
        textColorInput.value = textObject.fill;

        // Update button states
        boldBtn.classList.toggle('active', textObject.fontWeight === 'bold');
        italicBtn.classList.toggle('active', textObject.fontStyle === 'italic');
        underlineBtn.classList.toggle('active', textObject.underline === true);

        // Update alignment
        updateAlignmentButtons(textObject.textAlign);
    }

    function updateTextProperty(property, value) {
        const activeObject = canvas.getActiveObject();
        if (activeObject && activeObject.type === 'i-text') {
            activeObject.set(property, value);
            canvas.renderAll();
        }
    }

    // Handle object modifications
    canvas.on('object:modified', function () {
        history.saveState();
    });

    // Handle keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // Undo: Ctrl+Z
        if (e.key === 'z' && (e.ctrlKey || e.metaKey) && !e.shiftKey) {
            history.undo();
            e.preventDefault();
        }

        // Redo: Ctrl+Y or Ctrl+Shift+Z
        if ((e.key === 'y' && (e.ctrlKey || e.metaKey)) ||
            (e.key === 'z' && (e.ctrlKey || e.metaKey) && e.shiftKey)) {
            history.redo();
            e.preventDefault();
        }

        // Only process other shortcuts if not typing in a text field
        if (e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
            // Delete key for delete
            if (e.key === 'Delete' || e.key === 'Backspace') {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    canvas.remove(activeObject);
                    canvas.renderAll();
                    history.saveState();
                    e.preventDefault();
                }
            }

            // Ctrl+D for duplicate
            if (e.key === 'd' && (e.ctrlKey || e.metaKey)) {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    activeObject.clone(function (cloned) {
                        cloned.set({
                            left: cloned.left + 10,
                            top: cloned.top + 10,
                            evented: true,
                        });
                        canvas.add(cloned);
                        canvas.setActiveObject(cloned);
                        canvas.renderAll();
                        history.saveState();
                    });
                    e.preventDefault();
                }
            }

            // Arrow keys for moving objects
            if (e.key.startsWith('Arrow')) {
                const activeObject = canvas.getActiveObject();
                if (activeObject) {
                    const moveStep = e.shiftKey ? 10 : 1;

                    switch (e.key) {
                        case 'ArrowUp':
                            activeObject.top -= moveStep;
                            break;
                        case 'ArrowDown':
                            activeObject.top += moveStep;
                            break;
                        case 'ArrowLeft':
                            activeObject.left -= moveStep;
                            break;
                        case 'ArrowRight':
                            activeObject.left += moveStep;
                            break;
                    }

                    activeObject.setCoords();
                    canvas.renderAll();

                    if (e.shiftKey) { // Only save state on larger moves to avoid history spam
                        history.saveState();
                    }

                    e.preventDefault();
                }
            }

            // Toggle sidebar with Tab key
            if (e.key === 'Tab') {
                sidebar.classList.toggle('collapsed');
                if (toggleSidebarBtn) {
                    toggleSidebarBtn.innerHTML = sidebar.classList.contains('collapsed') ?
                        '<i class="fas fa-chevron-right"></i>' : '<i class="fas fa-chevron-left"></i>';
                }
                e.preventDefault();
                adjustCanvasScaling();
            }
        }
    });

    // Optimized canvas scaling based on available space
    function adjustCanvasScaling() {
        // Get reference to the editor container
        const editorContainer = document.querySelector('.editor-container');

        // Calculate available space
        let availableWidth = editorContainer.offsetWidth;

        // Adjust for sidebar if it's visible
        if (!sidebar.classList.contains('collapsed')) {
            availableWidth -= sidebar.offsetWidth;
        }

        // Account for padding
        availableWidth -= 40; // 20px padding on each side

        // Get canvas dimensions
        const canvasWidth = canvas.getWidth() / canvas.getZoom();

        // Calculate ideal zoom level
        let idealZoom = availableWidth / canvasWidth;

        // Constrain zoom level within reasonable bounds
        idealZoom = Math.max(0.5, Math.min(idealZoom, 1.2));

        // Only apply zoom if it's different enough from current (to avoid constant small adjustments)
        if (Math.abs(zoomLevel - idealZoom) > 0.05) {
            zoomLevel = idealZoom;
            canvas.setZoom(zoomLevel);
            canvas.setWidth({{ product_type.default_width }} * zoomLevel);
        canvas.setHeight({{ product_type.default_height }} * zoomLevel);
    canvas.renderAll();
            }
        }

    // Make adjustCanvasScaling available globally
    window.adjustCanvasScaling = adjustCanvasScaling;

    // Load initial canvas state if available
    const initialCanvasJSON = document.getElementById('initial-canvas-json');
    if (initialCanvasJSON && initialCanvasJSON.value) {
        try {
            console.log("Loading template from JSON");
            // Parse the JSON string into an object first
            const canvasData = JSON.parse(initialCanvasJSON.value);

            // Now load the JSON object into the canvas
            canvas.loadFromJSON(canvasData, function () {
                canvas.renderAll();
                console.log("Canvas template loaded successfully");

                // Select first object if available
                if (canvas.getObjects().length > 0) {
                    canvas.setActiveObject(canvas.getObjects()[0]);
                    canvas.renderAll();
                }

                // Initialize history with the loaded template
                history.saveState();
            });
        } catch (error) {
            console.error('Error loading initial canvas:', error);
            console.error('JSON string preview:', initialCanvasJSON.value.substring(0, 100) + '...');
        }
    }

    // Initialize with product image if available
    const productImage = document.getElementById('product-image');
    if (productImage) {
        // Product image is loaded
        console.log("Product image found");
    }

    // Add responsiveness to canvas container
    window.addEventListener('resize', function () {
        // Check if mobile view should be enabled/disabled
        const isMobileNow = window.innerWidth <= 768;

        if (isMobileNow && !document.body.classList.contains('mobile-view')) {
            document.body.classList.add('mobile-view');
            sidebar.classList.add('collapsed');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-right"></i>';
            }
            setupMobileControls();
        } else if (!isMobileNow && document.body.classList.contains('mobile-view')) {
            document.body.classList.remove('mobile-view');

            // Reset sidebar state if coming from mobile
            sidebar.classList.remove('collapsed');
            if (toggleSidebarBtn) {
                toggleSidebarBtn.innerHTML = '<i class="fas fa-chevron-left"></i>';
            }
        }

        // Adjust canvas scaling when window is resized
        setTimeout(adjustCanvasScaling, 300);
    });

    // Setup mobile-specific controls
    function setupMobileControls() {
        // Create fullscreen toggle button if it doesn't exist
        if (!document.getElementById('fullscreen-btn')) {
            const fullscreenBtn = document.createElement('button');
            fullscreenBtn.id = 'fullscreen-btn';
            fullscreenBtn.className = 'btn btn-outline-secondary btn-icon btn-fullscreen';
            fullscreenBtn.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
            fullscreenBtn.title = 'Toggle Fullscreen';

            // Add to canvas controls
            const canvasControls = document.querySelector('.canvas-controls');
            if (canvasControls) {
                const newGroup = document.createElement('div');
                newGroup.className = 'canvas-controls-group';
                newGroup.appendChild(fullscreenBtn);
                canvasControls.appendChild(newGroup);
            }

            // Add fullscreen toggle functionality
            fullscreenBtn.addEventListener('click', function () {
                document.body.classList.toggle('fullscreen-mode');

                if (document.body.classList.contains('fullscreen-mode')) {
                    sidebar.classList.add('collapsed');
                    this.innerHTML = '<i class="fas fa-compress-arrows-alt"></i>';
                    showMobileTooltip('Fullscreen mode');
                } else {
                    this.innerHTML = '<i class="fas fa-expand-arrows-alt"></i>';
                    showMobileTooltip('Normal mode');
                }

                // Adjust canvas scaling after toggling fullscreen
                setTimeout(adjustCanvasScaling, 300);
            });
        }

        // Create pan controls toggle if needed
        const panControls = document.querySelector('.pan-controls');
        if (panControls && !document.getElementById('pan-toggle-btn')) {
            const panToggleBtn = document.createElement('button');
            panToggleBtn.id = 'pan-toggle-btn';
            panToggleBtn.className = 'btn btn-outline-secondary btn-icon';
            panToggleBtn.innerHTML = '<i class="fas fa-arrows-alt"></i>';
            panToggleBtn.title = 'Toggle Pan Controls';

            // Insert before the pan controls
            panControls.parentNode.insertBefore(panToggleBtn, panControls);

            // Toggle pan controls visibility
            panToggleBtn.addEventListener('click', function () {
                panControls.classList.toggle('active');
                if (panControls.classList.contains('active')) {
                    showMobileTooltip('Pan controls visible');
                } else {
                    showMobileTooltip('Pan controls hidden');
                }
            });
        }

        // Add canvas controls toggle if needed
        const canvasControls = document.querySelector('.canvas-controls');
        if (canvasControls && !document.querySelector('.canvas-controls-toggle')) {
            const canvasControlsToggle = document.createElement('button');
            canvasControlsToggle.className = 'canvas-controls-toggle';
            canvasControlsToggle.innerHTML = '<i class="fas fa-sliders-h"></i>';
            document.body.appendChild(canvasControlsToggle);

            // Toggle canvas controls visibility
            canvasControlsToggle.addEventListener('click', function () {
                if (canvasControls.style.display === 'none') {
                    canvasControls.style.display = 'flex';
                    this.innerHTML = '<i class="fas fa-times"></i>';
                    showMobileTooltip('Controls visible');
                } else {
                    canvasControls.style.display = 'none';
                    this.innerHTML = '<i class="fas fa-sliders-h"></i>';
                    showMobileTooltip('Controls hidden');
                }
            });
        }

        // Add touch gesture support for panning if not already added
        if (canvasContainer && !canvasContainer.getAttribute('data-touch-enabled')) {
            canvasContainer.setAttribute('data-touch-enabled', 'true');

            let touching = false;
            let lastX = 0;
            let lastY = 0;

            canvasContainer.addEventListener('touchstart', function (e) {
                // Only if we have 2 fingers (to distinguish from object manipulation)
                if (e.touches.length === 2) {
                    touching = true;
                    lastX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    lastY = (e.touches[0].clientY + e.touches[1].clientY) / 2;
                    e.preventDefault(); // Prevent default to avoid scrolling
                }
            });

            canvasContainer.addEventListener('touchmove', function (e) {
                if (touching && e.touches.length === 2) {
                    // Calculate average position of both touches
                    const currentX = (e.touches[0].clientX + e.touches[1].clientX) / 2;
                    const currentY = (e.touches[0].clientY + e.touches[1].clientY) / 2;

                    // Calculate delta
                    const deltaX = currentX - lastX;
                    const deltaY = currentY - lastY;

                    // Pan the canvas
                    canvas.relativePan(new fabric.Point(deltaX, deltaY));

                    // Update last positions
                    lastX = currentX;
                    lastY = currentY;

                    e.preventDefault(); // Prevent default to avoid scrolling
                }
            });

            canvasContainer.addEventListener('touchend', function () {
                touching = false;
            });

            // Add double-tap to zoom for mobile
            let lastTapTime = 0;

            canvasContainer.addEventListener('touchend', function (e) {
                const currentTime = new Date().getTime();
                const tapLength = currentTime - lastTapTime;

                if (tapLength < 500 && tapLength > 0) {
                    // Double tap detected
                    e.preventDefault();

                    // Toggle between zoom levels
                    if (zoomLevel <= 1) {
                        zoomLevel = 1.5;
                    } else {
                        zoomLevel = 1;
                    }

                    updateZoom();
                    showMobileTooltip(zoomLevel > 1 ? 'Zoomed in' : 'Zoom reset');
                }

                lastTapTime = currentTime;
            });
        }

        // Show initial help tooltip
        showMobileTooltip('Tap to edit, use two fingers to pan');
    }

    // Initialize with proper canvas scaling and tooltip
    setTimeout(function () {
        adjustCanvasScaling();

        // Show welcome tooltip on mobile
        if (isMobile) {
            showMobileTooltip('Welcome to the design editor');
        }
    }, 500);
                     });



</script>

<script>

    document.addEventListener('DOMContentLoaded', function () {
            // Get reference to canvas from the main script
            const canvas = window.canvas;

            // Reference to history and helper functions
            const history = window.history;
            const showMobileTooltip = window.showMobileTooltip;

            // Shape buttons
            const addRectBtn = document.getElementById('add-rect-btn');
            const addCircleBtn = document.getElementById('add-circle-btn');
            const deleteShapeBtn = document.getElementById('delete-shape-btn');

            // Shape controls
            const rectangleControls = document.getElementById('rectangle-controls');
            const circleControls = document.getElementById('circle-controls');

            // Property controls
            const shapeFillColor = document.getElementById('shape-fill-color');
            const shapeStrokeColor = document.getElementById('shape-stroke-color');
            const shapeStrokeWidth = document.getElementById('shape-stroke-width-value');
            const shapeOpacity = document.getElementById('shape-opacity');
            const shapeOpacityValue = document.getElementById('shape-opacity-value');

            // Rectangle specific
            const rectWidth = document.getElementById('rect-width');
            const rectHeight = document.getElementById('rect-height');
            const rectRadius = document.getElementById('rect-radius');
            const rectRadiusValue = document.getElementById('rect-radius-value');

            // Circle specific
            const circleRadius = document.getElementById('circle-radius');
            const circleRadiusValue = document.getElementById('circle-radius-value');

            // Ensure the shapes tab is active when a shape action is performed
            function activateShapesTab() {
                // Find the shapes tab button and click it
                const shapesTabBtn = document.querySelector('[data-target="tab-shapes"]');
                if (shapesTabBtn && !shapesTabBtn.classList.contains('active')) {
                    shapesTabBtn.click();
                }
            }

            // Add rectangle
            if (addRectBtn) {
                addRectBtn.addEventListener('click', function () {
                    // Ensure shapes tab is active
                    activateShapesTab();

                    // Create rectangle
                    const rect = new fabric.Rect({
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        width: parseInt(rectWidth.value),
                        height: parseInt(rectHeight.value),
                        fill: shapeFillColor.value,
                        stroke: shapeStrokeColor.value,
                        strokeWidth: parseInt(shapeStrokeWidth.value),
                        rx: parseInt(rectRadiusValue.value),
                        ry: parseInt(rectRadiusValue.value),
                        opacity: parseFloat(shapeOpacity.value),
                        originX: 'center',
                        originY: 'center'
                    });

                    // Add to canvas
                    canvas.add(rect);
                    canvas.setActiveObject(rect);
                    canvas.renderAll();
                    history.saveState();

                    // Show rectangle controls, hide circle controls
                    if (rectangleControls) rectangleControls.style.display = 'block';
                    if (circleControls) circleControls.style.display = 'none';

                    showMobileTooltip('Rectangle added');
                });
            }

            // Add circle
            if (addCircleBtn) {
                addCircleBtn.addEventListener('click', function () {
                    // Ensure shapes tab is active
                    activateShapesTab();

                    // Create circle
                    const circle = new fabric.Circle({
                        left: canvas.width / 2,
                        top: canvas.height / 2,
                        radius: parseInt(circleRadiusValue.value),
                        fill: shapeFillColor.value,
                        stroke: shapeStrokeColor.value,
                        strokeWidth: parseInt(shapeStrokeWidth.value),
                        opacity: parseFloat(shapeOpacity.value),
                        originX: 'center',
                        originY: 'center'
                    });

                    // Add to canvas
                    canvas.add(circle);
                    canvas.setActiveObject(circle);
                    canvas.renderAll();
                    history.saveState();

                    // Show circle controls, hide rectangle controls
                    if (rectangleControls) rectangleControls.style.display = 'none';
                    if (circleControls) circleControls.style.display = 'block';

                    showMobileTooltip('Circle added');
                });
            }

            // Delete selected shape
            if (deleteShapeBtn) {
                deleteShapeBtn.addEventListener('click', function () {
                    const activeObject = canvas.getActiveObject();
                    if (activeObject) {
                        canvas.remove(activeObject);
                        canvas.renderAll();
                        history.saveState();
                        showMobileTooltip('Shape deleted');
                    }
                });
            }

            // Connect value displays for opacity
            if (shapeOpacity && shapeOpacityValue) {
                shapeOpacity.addEventListener('input', function () {
                    shapeOpacityValue.value = Math.round(this.value * 100);
                    updateShapeProperty('opacity', parseFloat(this.value));
                });

                shapeOpacityValue.addEventListener('input', function () {
                    shapeOpacity.value = this.value / 100;
                    updateShapeProperty('opacity', parseFloat(this.value / 100));
                });
            }

            // Connect rectangle radius controls
            if (rectRadius && rectRadiusValue) {
                rectRadius.addEventListener('input', function () {
                    rectRadiusValue.value = this.value;
                    updateRectangleProperty('rx', parseInt(this.value));
                    updateRectangleProperty('ry', parseInt(this.value));
                });

                rectRadiusValue.addEventListener('input', function () {
                    rectRadius.value = this.value;
                    updateRectangleProperty('rx', parseInt(this.value));
                    updateRectangleProperty('ry', parseInt(this.value));
                });
            }

            // Connect circle radius controls
            if (circleRadius && circleRadiusValue) {
                circleRadius.addEventListener('input', function () {
                    circleRadiusValue.value = this.value;
                    updateCircleProperty('radius', parseInt(this.value));
                });

                circleRadiusValue.addEventListener('input', function () {
                    circleRadius.value = this.value;
                    updateCircleProperty('radius', parseInt(this.value));
                });
            }

            // Basic property controls
            if (shapeFillColor) {
                shapeFillColor.addEventListener('input', function () {
                    updateShapeProperty('fill', this.value);
                });

                shapeFillColor.addEventListener('change', function () {
                    history.saveState();
                });
            }

            if (shapeStrokeColor) {
                shapeStrokeColor.addEventListener('input', function () {
                    updateShapeProperty('stroke', this.value);
                });

                shapeStrokeColor.addEventListener('change', function () {
                    history.saveState();
                });
            }

            if (shapeStrokeWidth) {
                shapeStrokeWidth.addEventListener('input', function () {
                    updateShapeProperty('strokeWidth', parseInt(this.value));
                });

                shapeStrokeWidth.addEventListener('change', function () {
                    history.saveState();
                });
            }

            if (rectWidth) {
                rectWidth.addEventListener('input', function () {
                    updateRectangleProperty('width', parseInt(this.value));
                });

                rectWidth.addEventListener('change', function () {
                    history.saveState();
                });
            }

            if (rectHeight) {
                rectHeight.addEventListener('input', function () {
                    updateRectangleProperty('height', parseInt(this.value));
                });

                rectHeight.addEventListener('change', function () {
                    history.saveState();
                });
            }

            // Color swatch functionality
            document.querySelectorAll('.color-swatch').forEach(swatch => {
                swatch.addEventListener('click', function () {
                    const color = this.getAttribute('data-color');
                    // Apply to closest color input
                    const colorInput = this.closest('.control-row').querySelector('input[type="color"]');
                    if (colorInput) {
                        colorInput.value = color;

                        // Trigger input event
                        const event = new Event('input', { bubbles: true });
                        colorInput.dispatchEvent(event);

                        // Save state
                        history.saveState();
                    }
                });
            });

            // Update properties functions
            function updateShapeProperty(property, value) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && (activeObject.type === 'rect' || activeObject.type === 'circle')) {
                    activeObject.set(property, value);
                    canvas.renderAll();
                }
            }

            function updateRectangleProperty(property, value) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'rect') {
                    activeObject.set(property, value);
                    canvas.renderAll();
                }
            }

            function updateCircleProperty(property, value) {
                const activeObject = canvas.getActiveObject();
                if (activeObject && activeObject.type === 'circle') {
                    activeObject.set(property, value);
                    canvas.renderAll();
                }
            }

            // Selection handling
            canvas.on('selection:created', updateShapeControls);
            canvas.on('selection:updated', updateShapeControls);

            function updateShapeControls(e) {
                const activeObject = e.selected[0];
                if (activeObject) {
                    // Activate shapes tab when selecting a shape
                    if (activeObject.type === 'rect' || activeObject.type === 'circle') {
                        activateShapesTab();

                        // Update common controls
                        shapeFillColor.value = activeObject.fill || '#3498db';
                        shapeStrokeColor.value = activeObject.stroke || '#2980b9';
                        shapeStrokeWidth.value = activeObject.strokeWidth || 2;
                        shapeOpacity.value = activeObject.opacity || 1;
                        shapeOpacityValue.value = Math.round((activeObject.opacity || 1) * 100);

                        // Show appropriate controls
                        if (activeObject.type === 'rect') {
                            if (rectangleControls) rectangleControls.style.display = 'block';
                            if (circleControls) circleControls.style.display = 'none';

                            // Update rectangle controls
                            rectWidth.value = activeObject.width || 150;
                            rectHeight.value = activeObject.height || 100;
                            rectRadius.value = activeObject.rx || 0;
                            rectRadiusValue.value = activeObject.rx || 0;
                        } else if (activeObject.type === 'circle') {
                            if (rectangleControls) rectangleControls.style.display = 'none';
                            if (circleControls) circleControls.style.display = 'block';

                            // Update circle controls
                            circleRadius.value = activeObject.radius || 50;
                            circleRadiusValue.value = activeObject.radius || 50;
                        }
                    }
                }
            }
     });
</script>



<script>
    function saveTemplateCanvas(templateId) {
        // Get canvas data
        const canvasData = canvas.toJSON();
        
        // Get canvas preview as base64 image
        const previewData = canvas.toDataURL({
            format: 'png',
            quality: 0.8
        });
        
        // Send to server
        fetch(`/custom/design-editor/${templateId}/save/`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCsrfToken()
            },
            body: JSON.stringify({
                canvas_json: canvasData,
                preview_image: previewData
            })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Handle redirect if it exists
                if (data.redirect_url) {
                    console.log("Redirect URL found:", data.redirect_url);
                    window.location.href = data.redirect_url;
                    return;
                }
                
                // Show success message if no redirect
                alert('Template saved successfully!');
            } else {
                alert('Error saving template: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('Error saving template. Please try again.');
        });
    }

</script>


{% endblock %}